<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Impara & Gioca! ‚Äì Anteprima</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&display=swap');
    body {
      font-family: 'Fredoka', sans-serif;
      background: linear-gradient(to bottom right, #f0f9ff, #e0f2fe);
      transition: transform 0.3s ease-in-out;
      transform-origin: top center;
    }
    .bg-card { background: linear-gradient(180deg, #dbeafe, #eff6ff); }
    .shadow-card { box-shadow: 0 15px 30px rgba(0,0,0,0.1); }
    .tag { background: #ffffff; border: 1px solid #dbeafe; color: #0c4a6e; }
    button {
      font-weight: 700;
      transition: transform 0.2s, box-shadow 0.2s, opacity 0.2s;
    }
    button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    button:active:not(:disabled) { transform: translateY(0); box-shadow: none; }
    button:disabled, select:disabled, input:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    .option {
      font-size: 1.15rem; padding: 0.9rem; border: 3px solid #cbd5e1;
      background: #f1f5f9; transition: border-color 0.2s, background-color 0.2s;
      cursor: pointer;
      animation: fadeIn 0.3s ease-out;
    }
    .option.correct { 
      border-color: #22c55e; 
      background: #dcfce7; 
      animation: correctAnswer 0.8s ease-out;
    }
    .option.wrong { 
      border-color: #ef4444; 
      background: #fee2e2; 
      animation: wrongAnswer 0.8s ease-out;
    }
    .progress-bar { transition: width 0.3s ease-in-out; }
    dialog {
      padding: 0; border: none; border-radius: 1.5rem;
      max-width: 800px; width: 90%;
    }
    dialog::backdrop { background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(5px); }
    .profile-image {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid white;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .image-placeholder {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background-color: #dbeafe;
      border: 3px dashed #93c5fd;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #3b82f6;
      font-size: 1.5rem;
      cursor: pointer;
    }

    /* Drawing Box Styles */
    #drawingBox {
      display: none;
      background: #ffffff;
      border: 3px solid #3b82f6;
      border-radius: 1rem;
      animation: slideIn 0.3s ease-out;
    }
    #drawingBox.show {
      display: block;
    }
    #drawingCanvas {
      border: 2px dashed #cbd5e1;
      border-radius: 0.5rem;
      cursor: crosshair;
      touch-action: none;
      background: #ffffff;
    }
    .color-palette {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    .color-btn {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      border: 3px solid #ffffff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .color-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .color-btn.active {
      border-color: #1e40af;
      box-shadow: 0 0 0 2px #3b82f6;
      transform: scale(1.2);
    }
    .brush-size-slider {
      width: 100%;
      height: 8px;
      border-radius: 5px;
      background: #cbd5e1;
      outline: none;
      opacity: 0.7;
      transition: opacity 0.2s;
    }
    .brush-size-slider:hover {
      opacity: 1;
    }
    .brush-size-slider::-webkit-slider-thumb {
      appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #3b82f6;
      cursor: pointer;
    }
    .brush-size-slider::-moz-range-thumb {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #3b82f6;
      cursor: pointer;
      border: none;
    }
    
    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes slideIn {
      from { opacity: 0; transform: translateX(30px); }
      to { opacity: 1; transform: translateX(0); }
    }
    
    @keyframes popIn {
      0% { transform: scale(0.8); opacity: 0; }
      70% { transform: scale(1.05); opacity: 1; }
      100% { transform: scale(1); opacity: 1; }
    }
    
    @keyframes correctAnswer {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    
    @keyframes wrongAnswer {
      0%, 100% { transform: translateX(0); }
      20%, 60% { transform: translateX(-5px); }
      40%, 80% { transform: translateX(5px); }
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    
    .animate-fadeIn { animation: fadeIn 0.5s ease-out; }
    .animate-slideIn { animation: slideIn 0.5s ease-out; }
    .animate-popIn { animation: popIn 0.4s ease-out; }
    .animate-pulse { animation: pulse 1s infinite; }
    
    #question {
      animation: fadeIn 0.5s ease-out;
    }
    
    .option {
      animation: fadeIn 0.3s ease-out;
    }
    
    .option:hover {
      animation: pulse 0.5s;
    }
  </style>
</head>
<body class="text-slate-800">
  <!-- Header -->
  <header class="p-6 bg-sky-300 text-white shadow-lg sticky top-0 z-50">
    <div class="max-w-7xl mx-auto flex flex-col sm:flex-row gap-4 items-center justify-between">
      <div class="flex items-center gap-4">
        <!-- Spazio per la foto del bimbo -->
        <div class="flex items-center gap-3">
          <div class="image-placeholder" id="profileImagePlaceholder">
            üë§
          </div>
          <img id="profileImage" class="profile-image hidden" src="" alt="Foto del bimbo">
        </div>
        <div class="text-4xl">üöÄ</div>
        <h1 class="text-3xl font-bold">Impara & Gioca!</h1>
        <div class="flex items-center gap-2 bg-sky-400 p-1 rounded-full ml-4">
          <button id="zoomOutBtn" class="text-2xl font-bold w-8 h-8 rounded-full bg-white text-sky-500 hover:bg-sky-100">-</button>
          <span id="zoomDisplay" class="text-lg font-semibold w-16 text-center" title="Livello di zoom">100%</span>
          <button id="zoomInBtn" class="text-2xl font-bold w-8 h-8 rounded-full bg-white text-sky-500 hover:bg-sky-100">+</button>
        </div>
      </div>
      <div class="flex flex-wrap items-center gap-4">
        <label class="tag flex items-center gap-2 p-2 rounded-full text-lg">
          <span class="text-xl">üë§</span> Io sono:
          <select id="profileSelect" class="bg-transparent border-none text-lg font-semibold cursor-pointer outline-none"></select>
        </label>
        <input id="newProfileName" type="text" placeholder="Nome nuovo amico" class="p-2 rounded-full text-slate-800 text-lg placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500" />
        <button id="addProfileBtn" class="bg-blue-500 text-white rounded-full px-6 py-2">Aggiungi un amico!</button>
      </div>
    </div>
  </header>
  <!-- Main Content -->
  <main class="max-w-7xl mx-auto p-4 md:p-8">
    <div class="bg-card shadow-card rounded-3xl p-6">
      <!-- Game Options -->
      <div class="flex flex-col md:flex-row gap-4 mb-6">
        <div class="flex flex-wrap items-center gap-4">
          <span class="tag flex items-center gap-2 p-2 rounded-full text-lg">
            <span class="text-xl">üìò</span> Materia:
            <select id="subject" class="bg-transparent border-none text-lg font-semibold cursor-pointer outline-none">
              <option>Matematica</option>
              <option>Inglese</option>
              <option>Italiano</option>
              <option>Geografia</option>
              <option>Scienze</option>
              <option>Musica</option>
            </select>
          </span>
          <span class="tag flex items-center gap-2 p-2 rounded-full text-lg">
            <span class="text-xl">üéØ</span> Livello:
            <select id="level" class="bg-transparent border-none text-lg font-semibold cursor-pointer outline-none">
              <option value="easy">Facile ‚≠ê</option>
              <option value="medium">Medio ‚≠ê‚≠ê</option>
              <option value="hard">Difficile ‚≠ê‚≠ê‚≠ê</option>
            </select>
          </span>
          <span id="mathOpsWrap" class="tag flex items-center gap-2 p-2 rounded-full text-lg hidden">
            <span class="text-xl">‚ûó</span> Operazioni:
            <label class="flex items-center gap-1 text-base"><input type="checkbox" class="mathop" value="add" checked> +</label>
            <label class="flex items-center gap-1 text-base"><input type="checkbox" class="mathop" value="sub" checked> ‚àí</label>
            <label class="flex items-center gap-1 text-base"><input type="checkbox" class="mathop" value="mul" checked> √ó</label>
            <label class="flex items-center gap-1 text-base"><input type="checkbox" class="mathop" value="div" checked> √∑</label>
          </span>
        </div>
        <div class="flex flex-wrap items-center gap-4 mt-4 md:mt-0 md:ml-auto">
          <span class="tag flex items-center gap-2 p-2 rounded-full text-lg">
            <span class="text-xl">üì¶</span> Domande:
            <select id="sessionSize" class="bg-transparent border-none text-lg font-semibold cursor-pointer outline-none">
              <option>5</option><option selected>10</option><option>15</option><option>20</option><option>30</option><option>40</option><option>50</option>
            </select>
          </span>
          <button id="startBtn" class="bg-green-500 text-white rounded-full px-8 py-3 text-xl animate-pulse">Inizia a Giocare! üöÄ</button>
        </div>
      </div>

      <!-- Progress Bar -->
      <div class="h-4 bg-sky-200 rounded-full overflow-hidden my-6">
        <div id="progressBar" class="h-full bg-green-400 progress-bar rounded-full" style="width:0%"></div>
      </div>

      <!-- Question & Help -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="bg-white shadow-md rounded-2xl p-6">
          <h3 class="text-2xl font-bold mb-4 animate-slideIn">üß© Domanda</h3>
          <div id="question" class="min-h-[150px] flex items-center justify-center p-4 border-4 border-dashed border-blue-200 rounded-xl text-2xl text-center animate-fadeIn">Premi "Inizia a Gioca!" per iniziare.</div>
          <div class="options grid gap-4 mt-6" id="options"></div>

          <!-- Campo risposta testuale + invio -->
          <div id="textAnswerWrap" class="mt-4 flex items-center gap-2">
            <input id="textAnswer" type="text" class="flex-1 p-3 rounded-xl border-2 border-slate-300 focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="Scrivi la tua risposta e premi Invio‚Ä¶" disabled>
            <button id="submitTextBtn" class="bg-blue-500 text-white rounded-xl px-5 py-3" disabled>Invia</button>
          </div>

          <!-- Drawing Toggle Button -->
          <div class="mt-4 text-center">
            <button id="drawingToggleBtn" class="bg-purple-500 text-white rounded-full px-6 py-3 text-lg" disabled>üé® Disegna</button>
          </div>

          <!-- Drawing Box -->
          <div id="drawingBox" class="mt-4 p-4">
            <div class="flex flex-col gap-4">
              <!-- Canvas -->
              <div class="flex justify-center">
                <canvas id="drawingCanvas" width="400" height="300"></canvas>
              </div>
              
              <!-- Drawing Controls -->
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Color Palette -->
                <div>
                  <label class="block text-sm font-semibold text-slate-700 mb-2">üé® Colori:</label>
                  <div class="color-palette">
                    <div class="color-btn active" style="background-color: #000000" data-color="#000000"></div>
                    <div class="color-btn" style="background-color: #ef4444" data-color="#ef4444"></div>
                    <div class="color-btn" style="background-color: #3b82f6" data-color="#3b82f6"></div>
                    <div class="color-btn" style="background-color: #22c55e" data-color="#22c55e"></div>
                    <div class="color-btn" style="background-color: #f59e0b" data-color="#f59e0b"></div>
                    <div class="color-btn" style="background-color: #8b5cf6" data-color="#8b5cf6"></div>
                    <div class="color-btn" style="background-color: #ec4899" data-color="#ec4899"></div>
                    <div class="color-btn" style="background-color: #6b7280" data-color="#6b7280"></div>
                  </div>
                </div>
                
                <!-- Brush Size -->
                <div>
                  <label class="block text-sm font-semibold text-slate-700 mb-2">‚úèÔ∏è Dimensione pennello:</label>
                  <input type="range" id="brushSize" min="1" max="20" value="3" class="brush-size-slider">
                  <div class="text-center text-sm text-slate-600 mt-1">
                    <span id="brushSizeDisplay">3</span>px
                  </div>
                </div>
              </div>
              
              <!-- Action Buttons -->
              <div class="flex flex-wrap justify-center gap-3">
                <button id="clearCanvasBtn" class="bg-red-400 text-white rounded-full px-4 py-2 text-sm">üóëÔ∏è Cancella tutto</button>
                <button id="saveDrawingBtn" class="bg-green-400 text-white rounded-full px-4 py-2 text-sm">üíæ Salva disegno</button>
              </div>
            </div>
          </div>

          <div class="text-center font-semibold text-lg mt-4" id="feedback"></div>
        </div>
        <div class="bg-white shadow-md rounded-2xl p-6">
          <h3 class="text-2xl font-bold mb-4 animate-slideIn">üí° Aiuto & Suggerimenti</h3>
          <div id="helpBox" class="min-h-[150px] flex items-center justify-center p-4 border-4 border-dashed border-blue-200 rounded-xl text-xl text-center animate-fadeIn">Inizia una partita per ricevere aiuto!</div>
          <div class="flex flex-wrap gap-3 mt-6 justify-center">
            <button id="hintBtn" class="bg-yellow-400 text-slate-800 rounded-full px-6 py-2 text-lg" disabled>üí° Aiuto</button>
            <button id="explainBtn" class="bg-orange-400 text-slate-800 rounded-full px-6 py-2 text-lg" disabled>üìñ Spiegazione</button>
            <button id="flashBtn" class="bg-purple-400 text-white rounded-full px-6 py-2 text-lg" disabled>üÉè Flashcard</button>
          </div>
        </div>
      </div>

      <!-- Statistics -->
      <div class="mt-8">
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 text-center">
          <div class="bg-white rounded-2xl p-5 shadow-inner animate-popIn">
            <span class="text-lg">‚≠ê Punteggio materia (selezionata)</span><br>
            <b id="subjectScore" class="text-3xl font-bold text-blue-500">0</b>
          </div>
          <div class="bg-white rounded-2xl p-5 shadow-inner animate-popIn">
            <span class="text-lg">üóìÔ∏è Gioco di oggi</span><br>
            <b id="todayCount" class="text-3xl font-bold text-purple-500">0</b>
          </div>
          <div class="bg-white rounded-2xl p-5 shadow-inner animate-popIn">
            <span class="text-lg">üèÜ Punteggio totale oggi</span><br>
            <b id="todayScore" class="text-3xl font-bold text-green-500">0</b>
          </div>
        </div>
        <div class="mt-8">
          <h3 class="text-2xl font-bold mb-4 text-center text-slate-700">Punteggi Totali per Materia</h3>
          <div id="totalScoresBySubject" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 text-center"></div>
        </div>
      </div>

      <div class="flex justify-center mt-8">
        <button id="progressBtn" class="bg-sky-400 text-white rounded-full px-8 py-3 text-lg">Mostra i miei progressi üìà</button>
      </div>
    </div>
  </main>
  <!-- Progress Dialog -->
  <dialog id="progressDialog">
    <div class="bg-sky-100 p-8 rounded-3xl shadow-xl border-4 border-blue-200">
      <h3 class="text-3xl font-bold text-center mb-6">üìà I Tuoi Progressi ‚Äì <span id="progressDate" class="text-sky-700"></span></h3>
      <div id="progressSummary" class="text-lg"></div>
      <div class="text-center mt-6">
        <button class="bg-red-400 text-white rounded-full px-8 py-3 text-lg" onclick="this.closest('dialog').close()">Chiudi ‚ùå</button>
      </div>
    </div>
  </dialog>
  <script>
  (function(){
    // ---------- Utilities ----------
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    const todayStr = () => new Date().toISOString().slice(0, 10);
    const formatDateIt = (isoDate) => {
      const d = new Date(isoDate);
      return d.toLocaleDateString('it-IT', { weekday: 'long', day: '2-digit', month: 'long', year: 'numeric' });
    };
    // ISO week string like 2025-W37
    function weekStr(dateObj = new Date()) {
      const d = new Date(Date.UTC(dateObj.getFullYear(), dateObj.getMonth(), dateObj.getDate()));
      const dayNum = d.getUTCDay() || 7; // Monday=1..Sunday=7
      d.setUTCDate(d.getUTCDate() + 4 - dayNum);
      const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
      const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1)/7);
      return `${d.getUTCFullYear()}-W${String(weekNo).padStart(2,'0')}`;
    }
    function formatWeekRange(weekKey) {
      try {
        const [y, w] = weekKey.split('-W');
        const year = parseInt(y, 10);
        const week = parseInt(w, 10);
        const simple = new Date(Date.UTC(year, 0, 1));
        const day = simple.getUTCDay() || 7;
        const daysToAdd = (week - 1) * 7 + (1 - day);
        const monday = new Date(simple);
        monday.setUTCDate(simple.getUTCDate() + daysToAdd);
        const sunday = new Date(monday);
        sunday.setUTCDate(monday.getUTCDate() + 6);
        return `Settimana ${week} (${monday.toLocaleDateString('it-IT')} - ${sunday.toLocaleDateString('it-IT')})`;
      } catch (e) { return weekKey; }
    }
    const rand = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
    const shuffle = arr => arr.map(v => [Math.random(), v]).sort((a, b) => a[0] - b[0]).map(x => x[1]);
    const pick = arr => arr[rand(0, arr.length - 1)];
    const simpleRandomId = () => `id-${Date.now().toString(36)}-${Math.random().toString(36).substring(2)}`;

    // ---------- Drawing System ----------
    let drawingState = {
      isDrawing: false,
      isDrawingBoxOpen: false,
      currentColor: '#000000',
      currentBrushSize: 3,
      canvas: null,
      ctx: null
    };

    function initDrawingSystem() {
      drawingState.canvas = $('#drawingCanvas');
      drawingState.ctx = drawingState.canvas.getContext('2d');
      
      // Set up canvas
      drawingState.ctx.lineCap = 'round';
      drawingState.ctx.lineJoin = 'round';
      drawingState.ctx.strokeStyle = drawingState.currentColor;
      drawingState.ctx.lineWidth = drawingState.currentBrushSize;
      
      setupDrawingEventListeners();
    }

    function setupDrawingEventListeners() {
      const canvas = drawingState.canvas;
      
      // Drawing Toggle Button
      $('#drawingToggleBtn').addEventListener('click', toggleDrawingBox);
      
      // Color Palette
      $$('.color-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          $$('.color-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          drawingState.currentColor = btn.dataset.color;
          drawingState.ctx.strokeStyle = drawingState.currentColor;
        });
      });
      
      // Brush Size Slider
      $('#brushSize').addEventListener('input', (e) => {
        drawingState.currentBrushSize = parseInt(e.target.value);
        drawingState.ctx.lineWidth = drawingState.currentBrushSize;
        $('#brushSizeDisplay').textContent = drawingState.currentBrushSize;
      });
      
      // Clear Canvas Button
      $('#clearCanvasBtn').addEventListener('click', clearCanvas);
      
      // Save Drawing Button
      $('#saveDrawingBtn').addEventListener('click', saveDrawing);
      
      // Mouse Events
      canvas.addEventListener('mousedown', startDrawing);
      canvas.addEventListener('mousemove', draw);
      canvas.addEventListener('mouseup', stopDrawing);
      canvas.addEventListener('mouseout', stopDrawing);
      
      // Touch Events (mobile/tablet)
      canvas.addEventListener('touchstart', handleTouch, { passive: false });
      canvas.addEventListener('touchmove', handleTouch, { passive: false });
      canvas.addEventListener('touchend', stopDrawing);
      canvas.addEventListener('touchcancel', stopDrawing);
    }
    
    function toggleDrawingBox() {
      const box = $('#drawingBox');
      drawingState.isDrawingBoxOpen = !drawingState.isDrawingBoxOpen;
      
      if (drawingState.isDrawingBoxOpen) {
        box.classList.add('show');
        $('#drawingToggleBtn').textContent = '‚ùå Chiudi Disegno';
        $('#drawingToggleBtn').className = 'bg-red-500 text-white rounded-full px-6 py-3 text-lg';
        // Resize canvas to fit container
        resizeCanvas();
      } else {
        box.classList.remove('show');
        $('#drawingToggleBtn').textContent = 'üé® Disegna';
        $('#drawingToggleBtn').className = 'bg-purple-500 text-white rounded-full px-6 py-3 text-lg';
      }
    }
    
    function resizeCanvas() {
      const canvas = drawingState.canvas;
      const container = canvas.parentElement;
      const containerWidth = container.clientWidth;
      const maxWidth = Math.min(400, containerWidth - 40);
      const ratio = 300 / 400; // height / width
      
      canvas.width = maxWidth;
      canvas.height = maxWidth * ratio;
      canvas.style.width = maxWidth + 'px';
      canvas.style.height = (maxWidth * ratio) + 'px';
      
      // Re-apply drawing settings
      drawingState.ctx.lineCap = 'round';
      drawingState.ctx.lineJoin = 'round';
      drawingState.ctx.strokeStyle = drawingState.currentColor;
      drawingState.ctx.lineWidth = drawingState.currentBrushSize;
    }
    
    function getMousePos(e) {
      const rect = drawingState.canvas.getBoundingClientRect();
      const scaleX = drawingState.canvas.width / rect.width;
      const scaleY = drawingState.canvas.height / rect.height;
      
      return {
        x: (e.clientX - rect.left) * scaleX,
        y: (e.clientY - rect.top) * scaleY
      };
    }
    
    function getTouchPos(e) {
      const rect = drawingState.canvas.getBoundingClientRect();
      const scaleX = drawingState.canvas.width / rect.width;
      const scaleY = drawingState.canvas.height / rect.height;
      
      return {
        x: (e.touches[0].clientX - rect.left) * scaleX,
        y: (e.touches[0].clientY - rect.top) * scaleY
      };
    }
    
    function startDrawing(e) {
      drawingState.isDrawing = true;
      const pos = getMousePos(e);
      drawingState.ctx.beginPath();
      drawingState.ctx.moveTo(pos.x, pos.y);
    }
    
    function draw(e) {
      if (!drawingState.isDrawing) return;
      
      const pos = getMousePos(e);
      drawingState.ctx.lineTo(pos.x, pos.y);
      drawingState.ctx.stroke();
    }
    
    function stopDrawing() {
      if (drawingState.isDrawing) {
        drawingState.isDrawing = false;
        drawingState.ctx.beginPath();
      }
    }
    
    function handleTouch(e) {
      e.preventDefault();
      
      if (e.type === 'touchstart') {
        drawingState.isDrawing = true;
        const pos = getTouchPos(e);
        drawingState.ctx.beginPath();
        drawingState.ctx.moveTo(pos.x, pos.y);
      } else if (e.type === 'touchmove' && drawingState.isDrawing) {
        const pos = getTouchPos(e);
        drawingState.ctx.lineTo(pos.x, pos.y);
        drawingState.ctx.stroke();
      }
    }
    
    function clearCanvas() {
      drawingState.ctx.clearRect(0, 0, drawingState.canvas.width, drawingState.canvas.height);
    }
    
    function saveDrawing() {
      const canvas = drawingState.canvas;
      const link = document.createElement('a');
      link.download = `disegno-${new Date().toISOString().slice(0,10)}-${Date.now()}.png`;
      link.href = canvas.toDataURL();
      link.click();
      
      // Show feedback
      const feedback = $('#feedback');
      const originalText = feedback.innerHTML;
      feedback.innerHTML = 'üé® Disegno salvato! üìÅ';
      setTimeout(() => {
        feedback.innerHTML = originalText;
      }, 2000);
    }

    // ---------- Storage ----------
    const STORAGE_KEY = 'kids_learner_v2';
    const defaultSubjects = ['Matematica', 'Inglese', 'Italiano', 'Geografia', 'Scienze', 'Musica'];
    const baseStats = () => ({ subjectScore: { easy: 0, medium: 0, hard: 0 }, today: {}, weeks: {}, unique: new Set(), uniqueArr: [] });

    function load() {
      let data;
      try {
        const storedData = localStorage.getItem(STORAGE_KEY);
        if (storedData) {
          data = JSON.parse(storedData);
          if (data.version !== 2) throw new Error("Invalid data version");
        } else {
          throw new Error("No data found");
        }
      } catch (e) {
        console.warn("Could not load data, starting fresh.", e.message);
        const id = simpleRandomId();
        data = {
          version: 2,
          currentProfileId: id,
          profiles: [{ id, name: 'Bimbo', created: new Date().toISOString(), subjects: objFromArray(defaultSubjects, baseStats) }]
        };
        save(data);
      }
      // Data migration and validation
      data.profiles.forEach(p => {
        defaultSubjects.forEach(s => {
          p.subjects[s] = p.subjects[s] || baseStats();
          if (typeof p.subjects[s].subjectScore !== 'object' || p.subjects[s].subjectScore === null) {
            p.subjects[s].subjectScore = { easy: 0, medium: 0, hard: 0 };
          }
          p.subjects[s].unique = new Set(p.subjects[s].uniqueArr || []);
        });
      });
      return data;
    }

    function save(data) {
      try {
        const clone = JSON.parse(JSON.stringify(data));
        clone.profiles.forEach(p => {
          defaultSubjects.forEach(s => {
            if (p.subjects[s] && p.subjects[s].unique) {
              p.subjects[s].uniqueArr = Array.from(p.subjects[s].unique);
              delete p.subjects[s].unique;
            }
          });
        });
        localStorage.setItem(STORAGE_KEY, JSON.stringify(clone));
      } catch (e) { console.error("Failed to save data:", e); }
    }

    function objFromArray(arr, fn) { const o = {}; arr.forEach(k => o[k] = fn()); return o; }

    // ---------- State ----------
    let app = load();
    let session = { running: false, size: 10, index: 0, current: null };

    // ---------- UI Management ----------
    function initProfiles() {
      const sel = '#profileSelect';
      const selEl = $(sel);
      selEl.innerHTML = '';
      app.profiles.forEach(p => { const opt = document.createElement('option'); opt.value = p.id; opt.textContent = p.name; selEl.appendChild(opt); });
      selEl.value = app.currentProfileId;
      updateAllUI();
    }

    function updateAllUI() {
      updateHeaderStats();
      updateTotalScoresDisplay();
      updateButtonStates();
      updateProfileImage();
    }

    function updateHeaderStats() {
      const p = getCurrentProfile();
      const subjData = p.subjects[$('#subject').value] || baseStats();
      const scores = subjData.subjectScore;
      const totalScore = (scores.easy || 0) + (scores.medium || 0) + (scores.hard || 0);
      $('#subjectScore').textContent = totalScore;
      updateTodayKpis();
    }

    function getCurrentProfile() {
      return app.profiles.find(p => p.id === app.currentProfileId) || app.profiles[0];
    }

    function updateTotalScoresDisplay() {
      const container = $('#totalScoresBySubject');
      const profile = getCurrentProfile();
      container.innerHTML = '';
      defaultSubjects.forEach(subject => {
        const subjScores = (profile.subjects[subject] || baseStats()).subjectScore;
        const total = (subjScores.easy || 0) + (subjScores.medium || 0) + (subjScores.hard || 0);
        container.innerHTML += `
          <div class="bg-white rounded-2xl p-3 shadow-inner animate-popIn">
            <span class="text-base font-semibold text-sky-800">${subject}</span><br>
            <b class="text-2xl font-bold text-blue-600">${total}</b>
            <div class="text-xs text-slate-500 mt-1 grid grid-cols-3 gap-1">
              <span>F: <b class="text-green-600">${subjScores.easy || 0}</b></span>
              <span>M: <b class="text-orange-500">${subjScores.medium || 0}</b></span>
              <span>D: <b class="text-red-600">${subjScores.hard || 0}</b></span>
            </div>
          </div>`;
      });
    }

    function updateButtonStates() {
      const isRunning = session.running;
      ['#subject', '#level', '#sessionSize', '#profileSelect', '#addProfileBtn', '#newProfileName', '#startBtn'].forEach(sel => $(sel).disabled = isRunning);
      ['#hintBtn', '#explainBtn', '#flashBtn', '#textAnswer', '#submitTextBtn', '#drawingToggleBtn'].forEach(sel => $(sel).disabled = !isRunning);
    }

    function updateProfileImage() {
      const profile = getCurrentProfile();
      const placeholder = $('#profileImagePlaceholder');
      const image = $('#profileImage');
      
      if (profile.image) {
        image.src = profile.image;
        image.classList.remove('hidden');
        placeholder.classList.add('hidden');
      } else {
        image.classList.add('hidden');
        placeholder.classList.remove('hidden');
      }
    }

    // ---------- Generators ----------
    function uniqueKeyGuard(profile, subject, key){ const s = profile.subjects[subject]; if(s.unique.has(key)) return false; s.unique.add(key); if(s.unique.size > 200) s.unique = new Set(Array.from(s.unique).slice(-200)); return true; }
    const Generators = {
      Matematica(level){
        const enabled = $$('.mathop:checked').map(i=>i.value);
        const op = pick(enabled.length?enabled:['add','sub','mul','div']);
        const ranges = {easy:[1,10], medium:[5,20], hard:[10,50]};
        const [a,b] = (function(){
          const [min,max]=ranges[level];
          if(op==='div'){ const divisor = rand(min, Math.max(min,Math.floor(max/2))); const quotient = rand(min, max>=30?10:max); return [divisor*quotient, divisor]; }
          return [rand(min,max), rand(min,max)];
        })();
        const text = {add:`${a} + ${b} = ?`, sub:`${a} ‚àí ${b} = ?`, mul:`${a} √ó ${b} = ?`, div:`${a} √∑ ${b} = ?`}[op];
        const answer = {add:a+b, sub:a-b, mul:a*b, div:Math.floor(a/b)}[op];
        const key = `M:${level}:${op}:${a}:${b}`;
        return { ok: (p)=>uniqueKeyGuard(p,'Matematica',key), q:text, options: makeNumberOptions(answer, level), correct: String(answer), hint: `Pensa ad aggiungere üëÜ o togliere üëá i numeri.`, explain: `Ricorda le regole di ${op}: la ${op==='add'?'somma':op==='sub'?'sottrazione':op==='mul'?'moltiplicazione':'divisione'} tra due numeri.`, flashcard: `1Ô∏è‚É£ Scrivi il primo numero.<br>2Ô∏è‚É£ Esegui l'operazione.<br>3Ô∏è‚É£ Scrivi il risultato.` };
      },
      Inglese(level){
        const wordsEasy = [['cat','gatto'],['dog','cane'],['house','casa'],['sun','sole'],['book','libro'],['car','auto'],['apple','mela'],['ball','palla'],['tree','albero'],['bird','uccello']];
        const wordsMed = [['family','famiglia'],['friend','amico'],['beautiful','bello'],['together','insieme'],['happy','felice'],['water','acqua'],['food','cibo'],['school','scuola'],['teacher','insegnante'],['student','studente']];
        const wordsHard = [['thought','pensiero'],['tomorrow','domani'],['usually','di solito'],['question','domanda'],['answer','risposta'],['develop','sviluppare'],['community','comunit√†'],['knowledge','conoscenza'],['important','importante'],['different','diverso']];
        const bank = level==='easy'?wordsEasy:level==='medium'?wordsMed:wordsHard;
        const [en,it] = pick(bank);
        const mode = pick(['it->en','en->it']);
        let q,correct,opts,hint,explain,flashcard;
        if(mode==='it->en'){
          q = `Traduci in inglese: "${it}"`; correct = en; opts = makeTextOptions(correct, bank.map(x=>x[0])); hint = `Pensa alla parola inglese che hai imparato per "${it}"`; explain = `Ricorda i suoni e le lettere delle parole inglesi.`; flashcard = `üáÆüáπ ‚Üí üá¨üáß\nGuarda la parola in italiano e prova a ricordare la sua traduzione.`;
        } else {
          q = `Cosa vuol dire in italiano: "${en}"`; correct = it; opts = makeTextOptions(correct, bank.map(x=>x[1])); hint = `Prova a ricordare il significato in italiano di "${en}".`; explain = `Ricorda le parole italiane che corrispondono alle parole inglesi.`; flashcard = `üá¨üáß ‚Üí üáÆüáπ\nGuarda la parola in inglese e prova a ricordare la sua traduzione.`;
        }
        const key = `E:${level}:${en}:${mode}`; return { ok:(p)=>uniqueKeyGuard(p,'Inglese',key), q, options:opts, correct, hint, explain, flashcard };
      },
      Italiano(level){
        const modes = ['articolo','vocale','plurale','aggettivo']; const mode = pick(modes);
        if(mode==='articolo'){
          const nouns=[["___ albero","l'"],["___ zaino","lo "],["___ scuola","la "],["___ ombrello","l'"],["___ gatto","il "],["___ tigre","la "]];
          const [phrase, art] = pick(nouns); const opts = makeTextOptions(art.trim(), ['il','lo','la',"l'"]); return pack('Completa con la parolina giusta: '+phrase, art.trim(), opts, 'Guarda la prima lettera della parola dopo.','Ricorda le regole per usare gli articoli determinativi.','L\'articolo determinativo accompagna il nome.');
        }
        if(mode==='vocale'){
          const letter = pick('aeiou'.split('')); const opts = makeTextOptions('vocale',['vocale','consonante']); return pack(`La letterina "${letter}" √® una‚Ä¶`, 'vocale', opts, 'Quando pronunci il suono, l\'aria esce libera dalla bocca.', 'Le vocali sono A, E, I, O, U.');
        }
        if(mode==='plurale'){
          const words=[["libro","libri"],["mela","mele"],["amico","amici"],["palla","palle"],["fiore","fiori"]]; const [sing,plu]=pick(words); const q=`Qual √® il plurale di "${sing}"?`; const opts = makeTextOptions(plu, words.map(x=>x[1])); return pack(q,plu,opts,'Cambia l\'ultima letterina della parola.','Ricorda come si forma il plurale dei nomi.','Se il nome finisce con -o, il plurale √® -i. Se finisce con -a, √® -e.');
        }
        if(mode==='aggettivo'){
          const adjectives=[["alto","alta","alti","alte"],["bello","bella","belli","belle"]]; const [m_s, f_s, m_p, f_p] = pick(adjectives); const choice = pick(['m_s','f_s','m_p','f_p']); let q, correct; if(choice === 'm_s'){q=`Qual √® il femminile di "${m_s}"?`; correct=f_s;} if(choice === 'f_s'){q=`Qual √® il plurale maschile di "${f_s}"?`; correct=m_p;} if(choice === 'm_p'){q=`Qual √® il singolare di "${m_p}"?`; correct=m_s;} if(choice === 'f_p'){q=`Qual √® il singolare femminile di "${f_p}"?`; correct=f_s;} const opts = makeTextOptions(correct, [m_s, f_s, m_p, f_p]); return pack(q,correct,opts,'Pensa a come l\'aggettivo cambia.','Gli aggettivi concordano in genere e numero con il nome.','Ricorda le desinenze: -o/-a e -i/-e.');
        }
        function pack(q,c,o,h,e,f){const k=`I:${level}:${q}`;return{ok:(p)=>uniqueKeyGuard(p,'Italiano',k),q,correct:c,options:o,hint:h,explain:e,flashcard:f};}
      },
      Geografia(level){ const capitals = {Europa:[["Italia","Roma"],["Francia","Parigi"],["Spagna","Madrid"],["Germania","Berlino"]], Mondo:[["Giappone","Tokyo"],["USA","Washington"],["Brasile","Brasilia"],["Cina","Pechino"]]}; const pool = level==='easy'?capitals.Europa:capitals.Mondo; const [country,cap] = pick(pool); const q=`Qual √® la capitale di ${country}?`; const opts = makeTextOptions(cap, pool.map(x=>x[1])); const key=`G:${level}:${country}`; return {ok:(p)=>uniqueKeyGuard(p,'Geografia',key), q, correct:cap, options:opts, hint:'√à la citt√† pi√π importante.', explain:`La capitale di ${country} √® ${cap}.`, flashcard:`Paese ‚Üí Capitale`}; },
      Scienze(level){ const modes = ['stato','animali','corpo','piante']; const mode = pick(modes); if(mode==='stato'){ const items=[["ghiaccio","solido"],["acqua","liquido"],["vapore","gassoso"]]; const [mat,st]=pick(items); const q=`Lo stato del "${mat}" √®‚Ä¶`; const opts=makeTextOptions(st,['solido','liquido','gassoso']); return pack(q,st,opts,'Pensa a com\'√® fatto.', 'Ricorda i tre stati della materia.', 'Solido (forma fissa), liquido (scorre), gassoso (si espande).'); } if(mode==='animali'){ const items=[["delfino","mammifero"],["aquila","uccello"],["trota","pesce"]]; const [ani,cl]=pick(items); const opts=makeTextOptions(cl,['mammifero','uccello','pesce','anfibio']); return pack(`Il ${ani} √® un‚Ä¶`,cl,opts,'Pensa a come nasce e come respira.', 'Ricorda le classi degli animali.', ' mammifero, uccello, pesce, ecc.'); } if(mode==='corpo'){ const items=[["cuore","pompa il sangue"],["polmoni","respirare"],["stomaco","digerire il cibo"]]; const [org,fun]=pick(items); const q=`Il ${org} serve per‚Ä¶`; const opts=makeTextOptions(fun, items.map(x=>x[1])); return pack(q,fun,opts,'√à un organo, che funzione ha?', 'Ogni organo del corpo ha una funzione.', 'Il corpo ha tante parti che lavorano insieme.'); } if(mode==='piante'){ const items=[["radici","assorbire acqua"],["foglie","fare la fotosintesi"],["fiore","fare i semi"]]; const [parte,fun]=pick(items); const q=`Le ${parte} servono per‚Ä¶`; const opts=makeTextOptions(fun, items.map(x=>x[1])); return pack(q,fun,opts,'Pensa a cosa fa quella parte.', 'Ricorda le funzioni delle parti di una pianta.', 'Radici, fusto, foglie, fiore.'); } function pack(q,c,o,h,e,f){const k=`S:${level}:${q}`;return{ok:(p)=>uniqueKeyGuard(p,'Scienze',k),q,correct:c,options:o,hint:h,explain:e,flashcard:f};} },
      Musica(level){ const modes = ['famiglia','ritmo','note']; const mode = pick(modes); if(mode==='famiglia'){ const items=[["violino","archi"],["flauto","fiati"],["tromba","ottoni"]]; const [inst,fam]=pick(items); const q=`A quale famiglia appartiene il ${inst}?`; const opts=makeTextOptions(fam,['archi','fiati','ottoni','percussioni']); return pack(q,fam,opts,'Pensa a come si suona.', 'Gli strumenti si raggruppano in famiglie.', 'Archi, fiati, ottoni, percussioni.'); } if(mode==='ritmo'){ const items=[["semibreve","4 battiti"],["minima","2 battiti"],["semiminima","1 battito"]]; const [note,val]=pick(items); const q=`Una ${note} vale‚Ä¶`; const opts=makeTextOptions(val,['4 battiti','2 battiti','1 battito']); return pack(q,val,opts,'Pensa a quanto dura il suono.', 'Ripassa la durata delle note.', 'Semibreve (4), Minima (2), Semiminima (1).'); } if(mode==='note'){ const noteSeq=['do','re','mi','fa','sol','la','si']; const idx=rand(0,noteSeq.length-2); const q=`Quale nota viene dopo "${noteSeq[idx]}"?`; const correct=noteSeq[idx+1]; const opts=makeTextOptions(correct, noteSeq); return pack(q,correct,opts,'Pensa alla scala musicale.', 'Ricorda la sequenza delle note.', 'Do, Re, Mi, Fa, Sol, La, Si.'); } function pack(q,c,o,h,e,f){const k=`Mu:${level}:${q}`;return{ok:(p)=>uniqueKeyGuard(p,'Musica',k),q,correct:c,options:o,hint:h,explain:e,flashcard:f};} }
    };
    function makeNumberOptions(answer, level) { const spread = level === 'easy' ? 3 : level === 'medium' ? 7 : 12; const set = new Set([String(answer)]); while (set.size < 4) { set.add(String(answer + rand(-spread, spread))); } return shuffle(Array.from(set)); }
    function makeTextOptions(correct, pool) { const set = new Set([correct]); const shuffled = shuffle(pool); for (const x of shuffled) { if (set.size >= 4) break; if (x !== correct) set.add(x); } return shuffle(Array.from(set)); }
    function pickGenerator() { const subj = $('#subject').value; const level = $('#level').value; return () => Generators[subj](level); }

    // ---------- Session & Scoring ----------
    const POINTS = { easy: 10, medium: 15, hard: 20 };

    function recordResult(correct) {
      const profile = getCurrentProfile();
      const subj = $('#subject').value;
      const level = $('#level').value;
      const pts = correct ? POINTS[level] : 0;
      const subjStats = profile.subjects[subj];

      if (typeof subjStats.subjectScore !== 'object' || subjStats.subjectScore === null) {
        subjStats.subjectScore = { easy: 0, medium: 0, hard: 0 };
      }
      subjStats.subjectScore[level] += pts;

      const todayKey = todayStr();
      const thisWeekKey = weekStr();
      const today = subjStats.today[todayKey] || (subjStats.today[todayKey] = { score: 0, completed: 0 });
      today.score += pts; today.completed += 1;
      // record per-week scores and keep history
      subjStats.weeks[thisWeekKey] = subjStats.weeks[thisWeekKey] || { score: 0, completed: 0 };
      subjStats.weeks[thisWeekKey].score += pts;
      subjStats.weeks[thisWeekKey].completed += 1;
      save(app);
      updateAllUI();
    }

    function updateTodayKpis() {
      const p = getCurrentProfile(); const date = todayStr();
      let totalScore = 0, totalCount = 0;
      defaultSubjects.forEach(s => { const d = p.subjects[s].today[date]; if (d) { totalScore += d.score; totalCount += d.completed; } });
      $('#todayScore').textContent = totalScore; $('#todayCount').textContent = totalCount;

      // week KPIs (current week)
      const wk = weekStr(); let weekScore = 0, weekCount = 0;
      defaultSubjects.forEach(s => { const w = p.subjects[s].weeks && p.subjects[s].weeks[wk]; if (w) { weekScore += w.score; weekCount += w.completed; } });
      // show week KPIs by repurposing the subjectScore element subtitle (or create new ones)
      // We'll append week info under the Today stats
      const existing = document.querySelector('#weekSummary');
      if (existing) existing.remove();
      const weekNode = document.createElement('div');
      weekNode.id = 'weekSummary';
      weekNode.className = 'mt-2 text-sm text-slate-600';
      weekNode.innerHTML = `Questa settimana: <b class="text-green-600">${weekScore}</b> punti ‚Ä¢ <b class="text-purple-600">${weekCount}</b> attivit√†`;
      document.querySelector('.mt-8 > .grid')?.appendChild(weekNode);
    }

    function startSession() {
      session = { running: true, size: parseInt($('#sessionSize').value, 10), index: 0, current: null };
      $('#progressBar').style.width = '0%';
      $('#feedback').textContent = '';
      $('#textAnswer').value = '';
      // Clear canvas when starting new session
      if (drawingState.canvas) {
        clearCanvas();
      }
      updateButtonStates();
      nextQuestion();
      $('#textAnswer').focus();
    }

    function renderQuestion(pak){
      session.current = pak;
      $('#question').innerHTML = pak.q;
      $('#question').classList.add('animate-fadeIn');
      // Remove animation class after animation completes to allow re-triggering
      setTimeout(() => {
        $('#question').classList.remove('animate-fadeIn');
      }, 500);
      
      const ops = $('#options'); ops.innerHTML = '';
      pak.options.forEach(opt => {
        const b = document.createElement('div');
        b.className = 'option rounded-xl';
        b.textContent = opt; b.tabIndex = 0;
        b.addEventListener('click', () => selectAnswerViaChoice(b, opt));
        ops.appendChild(b);
      });
      $('#helpBox').innerHTML = 'Premi i bottoni per un aiuto!';
      $('#feedback').textContent = '';
      // abilita input testo
      $('#textAnswer').disabled = !session.running;
      $('#submitTextBtn').disabled = !session.running;
      $('#textAnswer').value = '';
    }

    function nextQuestion() {
      const gen = pickGenerator();
      const profile = getCurrentProfile();
      let attempt = 0, pak;
      while(attempt < 50) {
        pak = gen();
        if (pak && typeof pak.ok === 'function' && pak.ok(profile)) break;
        attempt++;
      }
      if (attempt >= 50) {
        session.running = false;
        $('#question').innerHTML = 'Congratulazioni! Non ci sono pi√π domande uniche per queste impostazioni!';
        $('#options').innerHTML = ''; $('#feedback').textContent = 'Prova un altro livello o materia.';
        updateButtonStates(); return;
      }
      renderQuestion(pak);
    }

    function finishOrContinue() {
      setTimeout(() => {
        session.index++;
        $('#progressBar').style.width = `${Math.min(100, (session.index / session.size) * 100)}%`;
        if (session.index >= session.size) {
          session.running = false;
          $('#question').innerHTML = `üéâ Grandioso! Hai finito tutte le domande! üéâ`;
          $('#options').innerHTML = ''; $('#feedback').textContent = '';
          $('#helpBox').innerHTML = 'Hai completato la sessione! Gioca ancora!';
          updateButtonStates();
        } else {
          session.running = true; // nuova domanda
          updateButtonStates();
          nextQuestion();
          $('#textAnswer').focus();
        }
      }, 1200);
    }

    function normalize(val){ return String(val).trim().toLowerCase(); }

    function lockChoices(){ $$('#options .option').forEach(o => o.style.pointerEvents = 'none'); }

    function handleAnswerResult(isCorrect){
      $('#feedback').innerHTML = isCorrect ? `ü•≥ Bravissimo! +${POINTS[$('#level').value]} punti!` : `üò¢ Ops! La risposta era: <b>${session.current.correct}</b>.`;
      recordResult(isCorrect);
      finishOrContinue();
    }

    function selectAnswerViaChoice(el, value) {
      if (!session.running) return;
      session.running = false; // blocca
      lockChoices();
      const correct = normalize(value) === normalize(session.current.correct);
      el.classList.add(correct ? 'correct' : 'wrong');
      updateButtonStates();
      handleAnswerResult(correct);
    }

    function selectAnswerViaText() {
      if (!session.running) return;
      const input = $('#textAnswer');
      const val = input.value;
      if (!val.trim()) { input.focus(); return; }
      session.running = false; // blocca
      lockChoices();
      updateButtonStates();
      const correct = normalize(val) === normalize(session.current.correct);
      // evidenzia opzione corretta se presente
      $$('#options .option').forEach(o => {
        if (normalize(o.textContent) === normalize(session.current.correct)) {
          o.classList.add('correct');
        }
      });
      handleAnswerResult(correct);
    }

    // ---------- Event Listeners Setup ----------
    function setupEventListeners() {
      $('#startBtn').addEventListener('click', startSession);
      $('#hintBtn').addEventListener('click', () => { if (session.current) $('#helpBox').innerHTML = 'üí° <b>Aiuto:</b> ' + session.current.hint; });
      $('#explainBtn').addEventListener('click', () => { if (session.current) $('#helpBox').innerHTML = 'üìñ <b>Spiegazione:</b> ' + session.current.explain; });
      $('#flashBtn').addEventListener('click', () => { if (session.current) $('#helpBox').innerHTML = 'üÉè <b>Flashcard:</b><br>' + session.current.flashcard; });

      $('#submitTextBtn').addEventListener('click', selectAnswerViaText);
      $('#textAnswer').addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); selectAnswerViaText(); } });

      $('#addProfileBtn').addEventListener('click', () => {
        const name = ($('#newProfileName').value || '').trim();
        if (!name) { alert('Per favore, scrivi il nome del nuovo amico!'); return; }
        const id = simpleRandomId();
        app.profiles.push({ id, name, created: new Date().toISOString(), subjects: objFromArray(defaultSubjects, baseStats) });
        app.currentProfileId = id;
        save(app); initProfiles();
        $('#newProfileName').value = '';
      });

      $('#profileSelect').addEventListener('change', (e) => { app.currentProfileId = e.target.value; save(app); updateAllUI(); });
      $('#subject').addEventListener('change', () => { $('#mathOpsWrap').classList.toggle('hidden', $('#subject').value !== 'Matematica'); updateHeaderStats(); });
      $('#level').addEventListener('change', updateHeaderStats);

      $('#progressBtn').addEventListener('click', () => {
        const p = getCurrentProfile(); const date = todayStr(); const wk = weekStr();
        $('#progressDate').textContent = `${formatWeekRange(wk)} ‚Äì (aggiornato ${formatDateIt(date)})`;
        let html = '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">'; let totalScoreToday = 0, totalCompletedToday = 0, totalWeekScore = 0, totalWeekCompleted = 0;
        defaultSubjects.forEach(s => {
          const subjData = p.subjects[s] || baseStats();
          const todayData = subjData.today[date];
          const scoreToday = todayData ? todayData.score : 0; 
          const completedToday = todayData ? todayData.completed : 0;
          const weekData = subjData.weeks && subjData.weeks[wk] ? subjData.weeks[wk] : { score:0, completed:0 };
          const weekScore = weekData.score; const weekCompleted = weekData.completed;
          const totalScores = subjData.subjectScore;
          const totalSubjectScore = (totalScores.easy || 0) + (totalScores.medium || 0) + (totalScores.hard || 0);

          totalScoreToday += scoreToday; 
          totalCompletedToday += completedToday;
          totalWeekScore += weekScore; totalWeekCompleted += weekCompleted;

          if (totalSubjectScore > 0 || completedToday > 0 || weekCompleted > 0) {
            html += `
              <div class="bg-white rounded-xl p-4 shadow-inner text-base animate-popIn">
                <div class="font-bold text-sky-700 text-xl mb-1">${s}</div>
                <div>Del <b>${formatDateIt(date)}</b>: <b class="text-purple-500">${completedToday}</b> attivit√† ‚Ä¢ <b class="text-green-500">${scoreToday}</b> punti</div>
                <div class="mt-1">Questa settimana: <b class="text-purple-600">${weekCompleted}</b> attivit√† ‚Ä¢ <b class="text-green-600">${weekScore}</b> punti</div>
                <div class="mt-1">Punteggio Totale: <b class="text-blue-600 text-lg">${totalSubjectScore}</b> punti</div>
                <div class="text-sm text-slate-600 mt-1">
                  (Facile: <b class="text-green-600">${totalScores.easy || 0}</b>, 
                   Medio: <b class="text-orange-600">${totalScores.medium || 0}</b>, 
                   Difficile: <b class="text-red-600">${totalScores.hard || 0}</b>)
                </div>
              </div>`;
          }
        });
        html += '</div>';
        html += `<div class="bg-sky-200 rounded-xl p-4 mt-6 text-xl font-bold shadow-md text-center animate-popIn">Totale del <b>${formatDateIt(date)}</b>: <b>${totalCompletedToday}</b> attivit√† ‚Ä¢ <b>${totalScoreToday}</b> punti</div>`;
        html += `<div class="bg-sky-100 rounded-xl p-4 mt-4 text-lg font-bold shadow-md text-center animate-popIn">Totale questa settimana: <b>${totalWeekCompleted}</b> attivit√† ‚Ä¢ <b>${totalWeekScore}</b> punti</div>`;
        html += '<div class="mt-4 text-sm text-slate-600">Storico settimane (ultime 6):</div>';
        // weeks history for this profile grouped by subject
        const weeksMap = {};
        defaultSubjects.forEach(s => {
          const subjData = p.subjects[s] || baseStats();
          if (subjData.weeks) {
            Object.keys(subjData.weeks).forEach(wkKey => {
              weeksMap[wkKey] = weeksMap[wkKey] || { score:0, completed:0 };
              weeksMap[wkKey].score += subjData.weeks[wkKey].score;
              weeksMap[wkKey].completed += subjData.weeks[wkKey].completed;
            });
          }
        });
        const weeksSorted = Object.keys(weeksMap).sort().reverse().slice(0,6);
        html += '<div class="grid grid-cols-1 md:grid-cols-3 gap-2 mt-3">';
        weeksSorted.forEach(wkKey => { const w = weeksMap[wkKey]; html += `<div class="bg-white p-2 rounded-md text-sm shadow-inner animate-popIn">${formatWeekRange(wkKey)}: <b>${w.completed}</b> attivit√† ‚Ä¢ <b>${w.score}</b> punti</div>`; });
        html += '</div>';
        $('#progressSummary').innerHTML = html; $('#progressDialog').showModal();
      });

      let currentScale = 1.0; const ZOOM_STEP = 0.1, MAX_ZOOM = 1.6, MIN_ZOOM = 0.5;
      const updateZoom = () => { currentScale = Math.round(currentScale * 100) / 100; document.body.style.transform = `scale(${currentScale})`; $('#zoomDisplay').textContent = `${Math.round(currentScale * 100)}%`; $('#zoomInBtn').disabled = currentScale >= MAX_ZOOM; $('#zoomOutBtn').disabled = currentScale <= MIN_ZOOM; };
      $('#zoomInBtn').addEventListener('click', () => { if (currentScale < MAX_ZOOM) { currentScale += ZOOM_STEP; updateZoom(); } });
      $('#zoomOutBtn').addEventListener('click', () => { if (currentScale > MIN_ZOOM) { currentScale -= ZOOM_STEP; updateZoom(); } });
      updateZoom();

      // Aggiunta della funzionalit√† per caricare l'immagine del profilo
      $('#profileImagePlaceholder').addEventListener('click', () => {
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = 'image/*';
        fileInput.onchange = e => {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = function(event) {
              const profile = getCurrentProfile();
              profile.image = event.target.result;
              save(app);
              updateProfileImage();
            };
            reader.readAsDataURL(file);
          }
        };
        fileInput.click();
      });

      // Handle window resize for canvas
      window.addEventListener('resize', () => {
        if (drawingState.isDrawingBoxOpen) {
          resizeCanvas();
        }
      });
    }

    // ---------- App Boot ----------
    initProfiles();
    $('#mathOpsWrap').classList.toggle('hidden', $('#subject').value !== 'Matematica');
    setupEventListeners();
    initDrawingSystem();
  })();
  </script>
</body>
</html>
