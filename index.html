<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Impara & Gioca! ‚Äì Anteprima</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&display=swap');
    body {
      font-family: 'Fredoka', sans-serif;
      background: linear-gradient(to bottom right, #f0f9ff, #e0f2fe);
      transition: transform 0.3s ease-in-out;
      transform-origin: top center;
    }
    .bg-card { background: linear-gradient(180deg, #dbeafe, #eff6ff); }
    .shadow-card { box-shadow: 0 15px 30px rgba(0,0,0,0.1); }
    .tag { background: #ffffff; border: 1px solid #dbeafe; color: #0c4a6e; }
    button {
      font-weight: 700;
      transition: transform 0.2s, box-shadow 0.2s, opacity 0.2s;
    }
    button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    button:active:not(:disabled) { transform: translateY(0); box-shadow: none; }
    button:disabled, select:disabled, input:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    .option {
      font-size: 1.15rem; padding: 0.9rem; border: 3px solid #cbd5e1;
      background: #f1f5f9; transition: border-color 0.2s, background-color 0.2s;
      cursor: pointer;
      animation: fadeIn 0.3s ease-out;
    }
    .option.correct { 
      border-color: #22c55e; 
      background: #dcfce7; 
      animation: correctAnswer 0.8s ease-out;
    }
    .option.wrong { 
      border-color: #ef4444; 
      background: #fee2e2; 
      animation: wrongAnswer 0.8s ease-out;
    }
    .progress-bar { transition: width 0.3s ease-in-out; }
    dialog {
      padding: 0; border: none; border-radius: 1.5rem;
      max-width: 800px; width: 90%;
    }
    dialog::backdrop { background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(5px); }
    .profile-image {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid white;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .image-placeholder {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background-color: #dbeafe;
      border: 3px dashed #93c5fd;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #3b82f6;
      font-size: 1.5rem;
      cursor: pointer;
    }

    /* Drawing Box Styles */
    #drawingBox {
      display: none;
      background: #ffffff;
      border: 3px solid #3b82f6;
      border-radius: 1rem;
      animation: slideIn 0.3s ease-out;
    }
    #drawingBox.show {
      display: block;
    }
    #drawingCanvas {
      border: 2px dashed #cbd5e1;
      border-radius: 0.5rem;
      cursor: crosshair;
      touch-action: none;
      background: #ffffff;
    }
    .color-palette {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    .color-btn {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      border: 3px solid #ffffff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .color-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .color-btn.active {
      border-color: #1e40af;
      box-shadow: 0 0 0 2px #3b82f6;
      transform: scale(1.2);
    }
    .brush-size-slider {
      width: 100%;
      height: 8px;
      border-radius: 5px;
      background: #cbd5e1;
      outline: none;
      opacity: 0.7;
      transition: opacity 0.2s;
    }
    .brush-size-slider:hover {
      opacity: 1;
    }
    .brush-size-slider::-webkit-slider-thumb {
      appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #3b82f6;
      cursor: pointer;
    }
    .brush-size-slider::-moz-range-thumb {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #3b82f6;
      cursor: pointer;
      border: none;
    }
    
    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes slideIn {
      from { opacity: 0; transform: translateX(30px); }
      to { opacity: 1; transform: translateX(0); }
    }
    
    @keyframes popIn {
      0% { transform: scale(0.8); opacity: 0; }
      70% { transform: scale(1.05); opacity: 1; }
      100% { transform: scale(1); opacity: 1; }
    }
    
    @keyframes correctAnswer {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    
    @keyframes wrongAnswer {
      0%, 100% { transform: translateX(0); }
      20%, 60% { transform: translateX(-5px); }
      40%, 80% { transform: translateX(5px); }
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    
    .animate-fadeIn { animation: fadeIn 0.5s ease-out; }
    .animate-slideIn { animation: slideIn 0.5s ease-out; }
    .animate-popIn { animation: popIn 0.4s ease-out; }
    .animate-pulse { animation: pulse 1s infinite; }
    
    #question {
      animation: fadeIn 0.5s ease-out;
    }
    
    .option {
      animation: fadeIn 0.3s ease-out;
    }
    
    .option:hover {
      animation: pulse 0.5s;
    }
  </style>
</head>
<body class="text-slate-800">
  <header class="p-6 bg-sky-300 text-white shadow-lg sticky top-0 z-50">
    <div class="max-w-7xl mx-auto flex flex-col sm:flex-row gap-4 items-center justify-between">
      <div class="flex items-center gap-4">
        <div class="flex items-center gap-3">
          <div class="image-placeholder" id="profileImagePlaceholder">
            üë§
          </div>
          <img id="profileImage" class="profile-image hidden" src="" alt="Foto del bimbo">
        </div>
        <div class="text-4xl">üöÄ</div>
        <h1 class="text-3xl font-bold">Impara & Gioca!</h1>
        <div class="flex items-center gap-2 bg-sky-400 p-1 rounded-full ml-4">
          <button id="zoomOutBtn" class="text-2xl font-bold w-8 h-8 rounded-full bg-white text-sky-500 hover:bg-sky-100">-</button>
          <span id="zoomDisplay" class="text-lg font-semibold w-16 text-center" title="Livello di zoom">100%</span>
          <button id="zoomInBtn" class="text-2xl font-bold w-8 h-8 rounded-full bg-white text-sky-500 hover:bg-sky-100">+</button>
        </div>
      </div>
      <div class="flex flex-wrap items-center gap-4">
        <label class="tag flex items-center gap-2 p-2 rounded-full text-lg">
          <span class="text-xl">üë§</span> Io sono:
          <select id="profileSelect" class="bg-transparent border-none text-lg font-semibold cursor-pointer outline-none"></select>
        </label>
        <input id="newProfileName" type="text" placeholder="Nome nuovo amico" class="p-2 rounded-full text-slate-800 text-lg placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500" />
        <button id="addProfileBtn" class="bg-blue-500 text-white rounded-full px-6 py-2">Aggiungi un amico!</button>
      </div>
    </div>
  </header>
  <main class="max-w-7xl mx-auto p-4 md:p-8">
    <div class="bg-card shadow-card rounded-3xl p-6">
      <div class="flex flex-col md:flex-row gap-4 mb-6">
        <div class="flex flex-wrap items-center gap-4">
          <span class="tag flex items-center gap-2 p-2 rounded-full text-lg">
            <span class="text-xl">üìò</span> Materia:
            <select id="subject" class="bg-transparent border-none text-lg font-semibold cursor-pointer outline-none">
              <option>Matematica</option>
              <option>Inglese</option>
              <option>Italiano</option>
              <option>Geografia</option>
              <option>Scienze</option>
              <option>Musica</option>
            </select>
          </span>
          <span class="tag flex items-center gap-2 p-2 rounded-full text-lg">
            <span class="text-xl">üéØ</span> Livello:
            <select id="level" class="bg-transparent border-none text-lg font-semibold cursor-pointer outline-none">
              <option value="easy">Facile ‚≠ê</option>
              <option value="medium">Medio ‚≠ê‚≠ê</option>
              <option value="hard">Difficile ‚≠ê‚≠ê‚≠ê</option>
            </select>
          </span>
          <span id="mathOpsWrap" class="tag flex items-center gap-2 p-2 rounded-full text-lg hidden">
            <span class="text-xl">‚ûó</span> Operazioni:
            <label class="flex items-center gap-1 text-base"><input type="checkbox" class="mathop" value="add" checked> +</label>
            <label class="flex items-center gap-1 text-base"><input type="checkbox" class="mathop" value="sub" checked> ‚àí</label>
            <label class="flex items-center gap-1 text-base"><input type="checkbox" class="mathop" value="mul" checked> √ó</label>
            <label class="flex items-center gap-1 text-base"><input type="checkbox" class="mathop" value="div" checked> √∑</label>
          </span>
        </div>
        <div class="flex flex-wrap items-center gap-4 mt-4 md:mt-0 md:ml-auto">
          <span class="tag flex items-center gap-2 p-2 rounded-full text-lg">
            <span class="text-xl">üì¶</span> Domande:
            <select id="sessionSize" class="bg-transparent border-none text-lg font-semibold cursor-pointer outline-none">
              <option>5</option><option selected>10</option><option>15</option><option>20</option><option>30</option><option>40</option><option>50</option>
            </select>
          </span>
          <button id="startBtn" class="bg-green-500 text-white rounded-full px-8 py-3 text-xl animate-pulse">Inizia a Giocare! üöÄ</button>
          <button id="stopSessionBtn" class="bg-red-500 text-white rounded-full px-6 py-3 text-lg hidden">üè† Torna alle Materie</button>
        </div>
      </div>

      <div class="h-4 bg-sky-200 rounded-full overflow-hidden my-6">
        <div id="progressBar" class="h-full bg-green-400 progress-bar rounded-full" style="width:0%"></div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="bg-white shadow-md rounded-2xl p-6">
          <h3 class="text-2xl font-bold mb-4 animate-slideIn">üß© Domanda</h3>
          <div id="question" class="min-h-[150px] flex items-center justify-center p-4 border-4 border-dashed border-blue-200 rounded-xl text-2xl text-center animate-fadeIn">Premi "Inizia a Gioca!" per iniziare.</div>
          <div class="options grid gap-4 mt-6" id="options"></div>

          <div id="textAnswerWrap" class="mt-4 flex items-center gap-2">
            <input id="textAnswer" type="text" class="flex-1 p-3 rounded-xl border-2 border-slate-300 focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="Scrivi la tua risposta e premi Invio‚Ä¶" disabled>
            <button id="submitTextBtn" class="bg-blue-500 text-white rounded-xl px-5 py-3" disabled>Invia</button>
          </div>

          <div class="mt-4 flex flex-wrap justify-center gap-3">
            <button id="drawingToggleBtn" class="bg-purple-500 text-white rounded-full px-6 py-3 text-lg" disabled>üé® Disegna</button>
            <button id="nextQuestionBtn" class="bg-orange-500 text-white rounded-full px-6 py-3 text-lg hidden">‚è≠Ô∏è Prossima Domanda</button>
          </div>

          <div id="drawingBox" class="mt-4 p-4">
            <div class="flex flex-col gap-4">
              <div class="flex justify-center">
                <canvas id="drawingCanvas" width="400" height="300"></canvas>
              </div>
              
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-semibold text-slate-700 mb-2">üé® Colori:</label>
                  <div class="color-palette">
                    <div class="color-btn active" style="background-color: #000000" data-color="#000000"></div>
                    <div class="color-btn" style="background-color: #ef4444" data-color="#ef4444"></div>
                    <div class="color-btn" style="background-color: #3b82f6" data-color="#3b82f6"></div>
                    <div class="color-btn" style="background-color: #22c55e" data-color="#22c55e"></div>
                    <div class="color-btn" style="background-color: #f59e0b" data-color="#f59e0b"></div>
                    <div class="color-btn" style="background-color: #8b5cf6" data-color="#8b5cf6"></div>
                    <div class="color-btn" style="background-color: #ec4899" data-color="#ec4899"></div>
                    <div class="color-btn" style="background-color: #6b7280" data-color="#6b7280"></div>
                  </div>
                </div>
                
                <div>
                  <label class="block text-sm font-semibold text-slate-700 mb-2">‚úèÔ∏è Dimensione pennello:</label>
                  <input type="range" id="brushSize" min="1" max="20" value="3" class="brush-size-slider">
                  <div class="text-center text-sm text-slate-600 mt-1">
                    <span id="brushSizeDisplay">3</span>px
                  </div>
                </div>
              </div>
              
              <div class="flex flex-wrap justify-center gap-3">
                <button id="clearCanvasBtn" class="bg-red-400 text-white rounded-full px-4 py-2 text-sm">üóëÔ∏è Cancella tutto</button>
                <button id="saveDrawingBtn" class="bg-green-400 text-white rounded-full px-4 py-2 text-sm">üíæ Salva disegno</button>
              </div>
            </div>
          </div>

          <div class="text-center font-semibold text-lg mt-4" id="feedback"></div>
        </div>
        <div class="bg-white shadow-md rounded-2xl p-6">
          <h3 class="text-2xl font-bold mb-4 animate-slideIn">üí° Aiuto & Suggerimenti</h3>
          <div id="helpBox" class="min-h-[150px] flex items-center justify-center p-4 border-4 border-dashed border-blue-200 rounded-xl text-xl text-center animate-fadeIn">Inizia una partita per ricevere aiuto!</div>
          <div class="flex flex-wrap gap-3 mt-6 justify-center">
            <button id="hintBtn" class="bg-yellow-400 text-slate-800 rounded-full px-6 py-2 text-lg" disabled>üí° Aiuto</button>
            <button id="explainBtn" class="bg-orange-400 text-slate-800 rounded-full px-6 py-2 text-lg" disabled>üìñ Spiegazione</button>
            <button id="flashBtn" class="bg-purple-400 text-white rounded-full px-6 py-2 text-lg" disabled>üÉè Flashcard</button>
          </div>
        </div>
      </div>

      <div class="mt-8">
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 text-center">
          <div class="bg-white rounded-2xl p-5 shadow-inner animate-popIn">
            <span class="text-lg">‚≠ê Punteggio materia (selezionata)</span><br>
            <b id="subjectScore" class="text-3xl font-bold text-blue-500">0</b>
          </div>
          <div class="bg-white rounded-2xl p-5 shadow-inner animate-popIn">
            <span class="text-lg">üóìÔ∏è Gioco di oggi</span><br>
            <b id="todayCount" class="text-3xl font-bold text-purple-500">0</b>
          </div>
          <div class="bg-white rounded-2xl p-5 shadow-inner animate-popIn">
            <span class="text-lg">üèÜ Punteggio totale oggi</span><br>
            <b id="todayScore" class="text-3xl font-bold text-green-500">0</b>
          </div>
        </div>
        <div class="mt-8">
          <h3 class="text-2xl font-bold mb-4 text-center text-slate-700">Punteggi Totali per Materia</h3>
          <div id="totalScoresBySubject" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 text-center"></div>
        </div>
      </div>

      <div class="flex justify-center mt-8">
        <button id="progressBtn" class="bg-sky-400 text-white rounded-full px-8 py-3 text-lg">Mostra i miei progressi üìà</button>
      </div>
    </div>
  </main>
  <dialog id="progressDialog">
    <div class="bg-sky-100 p-8 rounded-3xl shadow-xl border-4 border-blue-200">
      <h3 class="text-3xl font-bold text-center mb-6">üìà I Tuoi Progressi ‚Äì <span id="progressDate" class="text-sky-700"></span></h3>
      <div id="progressSummary" class="text-lg"></div>
      <div class="text-center mt-6">
        <button class="bg-red-400 text-white rounded-full px-8 py-3 text-lg" onclick="this.closest('dialog').close()">Chiudi ‚ùå</button>
      </div>
    </div>
  </dialog>
  <script>
  (function(){
    // ---------- Utilities ----------
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    const todayStr = () => new Date().toISOString().slice(0, 10);
    const formatDateIt = (isoDate) => {
      const d = new Date(isoDate);
      return d.toLocaleDateString('it-IT', { weekday: 'long', day: '2-digit', month: 'long', year: 'numeric' });
    };
    function weekStr(dateObj = new Date()) {
      const d = new Date(Date.UTC(dateObj.getFullYear(), dateObj.getMonth(), dateObj.getDate()));
      const dayNum = d.getUTCDay() || 7;
      d.setUTCDate(d.getUTCDate() + 4 - dayNum);
      const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
      const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1)/7);
      return `${d.getUTCFullYear()}-W${String(weekNo).padStart(2,'0')}`;
    }
    function formatWeekRange(weekKey) {
      try {
        const [y, w] = weekKey.split('-W');
        const year = parseInt(y, 10);
        const week = parseInt(w, 10);
        const simple = new Date(Date.UTC(year, 0, 1));
        const day = simple.getUTCDay() || 7;
        const daysToAdd = (week - 1) * 7 + (1 - day);
        const monday = new Date(simple);
        monday.setUTCDate(simple.getUTCDate() + daysToAdd);
        const sunday = new Date(monday);
        sunday.setUTCDate(monday.getUTCDate() + 6);
        return `Settimana ${week} (${monday.toLocaleDateString('it-IT')} - ${sunday.toLocaleDateString('it-IT')})`;
      } catch (e) { return weekKey; }
    }
    const rand = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
    const shuffle = arr => arr.map(v => [Math.random(), v]).sort((a, b) => a[0] - b[0]).map(x => x[1]);
    const pick = arr => arr[rand(0, arr.length - 1)];
    const simpleRandomId = () => `id-${Date.now().toString(36)}-${Math.random().toString(36).substring(2)}`;

    // ---------- Drawing System ----------
    let drawingState = {
      isDrawing: false,
      isDrawingBoxOpen: false,
      currentColor: '#000000',
      currentBrushSize: 3,
      canvas: null,
      ctx: null
    };

    function initDrawingSystem() {
      drawingState.canvas = $('#drawingCanvas');
      drawingState.ctx = drawingState.canvas.getContext('2d');
      
      drawingState.ctx.lineCap = 'round';
      drawingState.ctx.lineJoin = 'round';
      drawingState.ctx.strokeStyle = drawingState.currentColor;
      drawingState.ctx.lineWidth = drawingState.currentBrushSize;
      
      setupDrawingEventListeners();
    }

    function setupDrawingEventListeners() {
      const canvas = drawingState.canvas;
      
      $('#drawingToggleBtn').addEventListener('click', toggleDrawingBox);
      
      $$('.color-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          $$('.color-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          drawingState.currentColor = btn.dataset.color;
          drawingState.ctx.strokeStyle = drawingState.currentColor;
        });
      });
      
      $('#brushSize').addEventListener('input', (e) => {
        drawingState.currentBrushSize = parseInt(e.target.value);
        drawingState.ctx.lineWidth = drawingState.currentBrushSize;
        $('#brushSizeDisplay').textContent = drawingState.currentBrushSize;
      });
      
      $('#clearCanvasBtn').addEventListener('click', clearCanvas);
      
      $('#saveDrawingBtn').addEventListener('click', saveDrawing);
      
      canvas.addEventListener('mousedown', startDrawing);
      canvas.addEventListener('mousemove', draw);
      canvas.addEventListener('mouseup', stopDrawing);
      canvas.addEventListener('mouseout', stopDrawing);
      
      canvas.addEventListener('touchstart', handleTouch, { passive: false });
      canvas.addEventListener('touchmove', handleTouch, { passive: false });
      canvas.addEventListener('touchend', stopDrawing);
      canvas.addEventListener('touchcancel', stopDrawing);
    }
    
    function toggleDrawingBox() {
      const box = $('#drawingBox');
      drawingState.isDrawingBoxOpen = !drawingState.isDrawingBoxOpen;
      
      if (drawingState.isDrawingBoxOpen) {
        box.classList.add('show');
        $('#drawingToggleBtn').textContent = '‚ùå Chiudi Disegno';
        $('#drawingToggleBtn').className = 'bg-red-500 text-white rounded-full px-6 py-3 text-lg';
        resizeCanvas();
      } else {
        box.classList.remove('show');
        $('#drawingToggleBtn').textContent = 'üé® Disegna';
        $('#drawingToggleBtn').className = 'bg-purple-500 text-white rounded-full px-6 py-3 text-lg';
      }
    }
    
    function resizeCanvas() {
      const canvas = drawingState.canvas;
      const container = canvas.parentElement;
      const containerWidth = container.clientWidth;
      const maxWidth = Math.min(400, containerWidth - 40);
      const ratio = 300 / 400;
      
      canvas.width = maxWidth;
      canvas.height = maxWidth * ratio;
      canvas.style.width = maxWidth + 'px';
      canvas.style.height = (maxWidth * ratio) + 'px';
      
      drawingState.ctx.lineCap = 'round';
      drawingState.ctx.lineJoin = 'round';
      drawingState.ctx.strokeStyle = drawingState.currentColor;
      drawingState.ctx.lineWidth = drawingState.currentBrushSize;
    }
    
    function startDrawing(e) {
      drawingState.isDrawing = true;
      const pos = getMousePos(e);
      drawingState.ctx.beginPath();
      drawingState.ctx.moveTo(pos.x, pos.y);
    }

    function draw(e) {
      if (!drawingState.isDrawing) return;
      const pos = getMousePos(e);
      drawingState.ctx.lineTo(pos.x, pos.y);
      drawingState.ctx.stroke();
    }
    
    function stopDrawing() {
      drawingState.isDrawing = false;
    }
    
    function clearCanvas() {
      drawingState.ctx.clearRect(0, 0, drawingState.canvas.width, drawingState.canvas.height);
    }

    function saveDrawing() {
      const dataURL = drawingState.canvas.toDataURL('image/png');
      const a = document.createElement('a');
      a.href = dataURL;
      a.download = 'disegno.png';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }
    
    function getMousePos(e) {
      const rect = drawingState.canvas.getBoundingClientRect();
      let clientX, clientY;
      if (e.touches) {
        clientX = e.touches[0].clientX;
        clientY = e.touches[0].clientY;
      } else {
        clientX = e.clientX;
        clientY = e.clientY;
      }
      return {
        x: (clientX - rect.left) / (rect.right - rect.left) * drawingState.canvas.width,
        y: (clientY - rect.top) / (rect.bottom - rect.top) * drawingState.canvas.height
      };
    }

    function handleTouch(e) {
      e.preventDefault();
      const canvas = drawingState.canvas;
      const touch = e.touches[0];
      const mouseEvent = new MouseEvent(
        {
          'touchstart': 'mousedown',
          'touchmove': 'mousemove',
          'touchend': 'mouseup'
        }[e.type],
        {
          clientX: touch.clientX,
          clientY: touch.clientY
        }
      );
      canvas.dispatchEvent(mouseEvent);
    }

    // ---------- Data & State ----------
    const DATA = {
      Matematica: {
        easy: {
          questions: [
            {q: "Qual √® il risultato di 2 + 3?", a: "5", options: ["4", "5", "6", "7"]},
            {q: "Quanto fa 5 - 1?", a: "4", options: ["3", "4", "5", "6"]},
            {q: "Calcola 10 + 2", a: "12", options: ["11", "12", "13", "14"]},
            {q: "Quanto fa 8 - 3?", a: "5", options: ["4", "5", "6", "7"]},
            {q: "Calcola 4 + 4", a: "8", options: ["7", "8", "9", "10"]},
            {q: "Quanto fa 9 - 2?", a: "7", options: ["6", "7", "8", "9"]},
            {q: "Calcola 6 + 1", a: "7", options: ["5", "6", "7", "8"]},
            {q: "Quanto fa 7 - 4?", a: "3", options: ["2", "3", "4", "5"]},
            {q: "Quanto fa 3 + 6?", a: "9", options: ["8", "9", "10", "11"]},
            {q: "Calcola 15 - 5", a: "10", options: ["9", "10", "11", "12"]}
          ]
        },
        medium: {
          questions: [
            {q: "Quanto fa 5 x 6?", a: "30", options: ["25", "30", "35", "40"]},
            {q: "Calcola 20 √∑ 4", a: "5", options: ["4", "5", "6", "7"]},
            {q: "Risultato di 7 x 3", a: "21", options: ["18", "21", "24", "28"]},
            {q: "Quanto fa 45 √∑ 9?", a: "5", options: ["4", "5", "6", "7"]},
            {q: "Calcola 8 x 8", a: "64", options: ["56", "64", "72", "80"]},
            {q: "Quanto fa 63 √∑ 7?", a: "9", options: ["8", "9", "10", "11"]},
            {q: "Risultato di 9 x 4", a: "36", options: ["32", "36", "40", "45"]},
            {q: "Quanto fa 56 √∑ 8?", a: "7", options: ["6", "7", "8", "9"]},
            {q: "Calcola 12 x 5", a: "60", options: ["50", "55", "60", "65"]},
            {q: "Quanto fa 81 √∑ 9?", a: "9", options: ["8", "9", "10", "11"]}
          ]
        },
        hard: {
          questions: [
            {q: "Quanto fa (4 + 5) x 3?", a: "27", options: ["18", "21", "24", "27"]},
            {q: "Calcola 100 - (10 x 5)", a: "50", options: ["40", "50", "60", "70"]},
            {q: "Risultato di 7 + 8 x 2", a: "23", options: ["30", "23", "17", "15"]},
            {q: "Quanto fa (50 √∑ 5) - 2?", a: "8", options: ["6", "8", "10", "12"]},
            {q: "Calcola 3 x (9 - 4)", a: "15", options: ["15", "18", "21", "24"]},
            {q: "Quanto fa 4¬≤ - 5?", a: "11", options: ["9", "11", "13", "16"]},
            {q: "Risultato di (60 / 6) + 10", a: "20", options: ["18", "19", "20", "21"]},
            {q: "Quanto fa 30 √∑ (2 x 3)?", a: "5", options: ["4", "5", "6", "7"]},
            {q: "Calcola 15 + 5 x 2", a: "25", options: ["40", "25", "20", "17"]},
            {q: "Quanto fa 70 - 7 x 7?", a: "21", options: ["21", "35", "42", "49"]}
          ]
        }
      },
      Italiano: {
        easy: {
          questions: [
            {q: "Quale animale fa 'bau bau'?", a: "cane", type: "text", hint: "√à il migliore amico dell'uomo."},
            {q: "Come si chiama il nostro pianeta?", a: "Terra", type: "text", hint: "√à il terzo pianeta dal Sole."},
            {q: "Quale parola √® un nome?", a: "tavolo", options: ["bello", "mangiare", "tavolo", "veloce"]},
            {q: "Completa la frase: 'Il gatto...'", a: "miagola", options: ["abbaia", "miagola", "canta", "ride"]},
            {q: "Quale parola √® il contrario di 'grande'?", a: "piccolo", options: ["alto", "forte", "piccolo", "largo"]}
          ]
        },
        medium: {
          questions: [
            {q: "Qual √® il sinonimo di 'allegro'?", a: "felice", type: "text", hint: "Sinonimo di contento."},
            {q: "In quale verso √® scritto il Vangelo?", a: "prosa", options: ["poesia", "prosa", "rima", "strofa"]},
            {q: "Quale di queste √® una congiunzione?", a: "e", options: ["sul", "che", "e", "perch√©"]},
            {q: "Qual √® il plurale di 'citt√†'?", a: "citt√†", options: ["citt√†", "cittade", "citti", "cittai"]},
            {q: "Correggi l'errore: 'Oggi e bel tempo'", a: "Oggi √® bel tempo", type: "text", hint: "C'√® un accento da aggiungere."}
          ]
        },
        hard: {
          questions: [
            {q: "Quale figura retorica √® 'Il sole ride'?", a: "personificazione", type: "text", hint: "Quando si danno caratteristiche umane a oggetti o animali."},
            {q: "Quale di questi √® un verbo al congiuntivo imperfetto?", a: "andasse", options: ["andr√†", "andassi", "andava", "andasse"]},
            {q: "Definisci 'iperbole'", a: "Esagerazione", type: "text", hint: "√à un sinonimo di esagerazione."}
          ]
        }
      },
      Inglese: {
        easy: {
          questions: [
            {q: "Come si dice 'gatto' in inglese?", a: "cat", type: "text", hint: "Ha 3 lettere."},
            {q: "Come si dice 'cane' in inglese?", a: "dog", type: "text", hint: "Ha 3 lettere."},
            {q: "What is 'rosso' in English?", a: "red", type: "text", hint: "It rhymes with 'bed'."},
            {q: "Which one is an animal?", a: "horse", options: ["chair", "table", "horse", "car"]},
            {q: "What is the English word for 'sole'?", a: "sun", options: ["moon", "star", "sun", "cloud"]}
          ]
        },
        medium: {
          questions: [
            {q: "What is the past tense of 'go'?", a: "went", options: ["gone", "goed", "went", "goes"]},
            {q: "How do you say 'libro' in English?", a: "book", type: "text", hint: "Starts with 'b', ends with 'k'."},
            {q: "Translate 'Mi piace la pizza' into English", a: "I like pizza", type: "text", hint: "Starts with 'I'."}
          ]
        },
        hard: {
          questions: [
            {q: "Fill in the blank: 'I would have ____ (be) there.'", a: "been", type: "text", hint: "Past participle of 'to be'."},
            {q: "Correct the sentence: 'He don't like milk.'", a: "He doesn't like milk.", type: "text", hint: "The verb needs to be conjugated correctly."}
          ]
        }
      }
    };

    let sessionState = {
      currentProfile: null,
      currentSubject: 'Matematica',
      currentLevel: 'easy',
      questions: [],
      currentQuestionIndex: 0,
      correctAnswers: 0,
      totalQuestions: 0,
      isSessionActive: false,
      userScores: JSON.parse(localStorage.getItem('userScores')) || {}
    };

    // ---------- User & Profile Management ----------
    function initProfiles() {
      const savedProfile = localStorage.getItem('currentProfile');
      if (savedProfile) {
        sessionState.currentProfile = savedProfile;
      } else {
        const defaultProfile = 'Amico1';
        if (!sessionState.userScores[defaultProfile]) {
          sessionState.userScores[defaultProfile] = { totalScore: 0, todayScore: 0, todayDate: todayStr(), subjectScores: {}, weeklyScores: {} };
        }
        sessionState.currentProfile = defaultProfile;
        localStorage.setItem('currentProfile', defaultProfile);
        updateScoreDisplay();
      }
      loadProfiles();
      checkTodayScore();
    }
    
    function loadProfiles() {
      const profileSelect = $('#profileSelect');
      profileSelect.innerHTML = '';
      const profiles = Object.keys(sessionState.userScores);
      profiles.forEach(name => {
        const option = document.createElement('option');
        option.value = name;
        option.textContent = name;
        profileSelect.appendChild(option);
      });
      profileSelect.value = sessionState.currentProfile;
      updateProfileImage();
    }
    
    function addProfile() {
      const newName = $('#newProfileName').value.trim();
      if (newName && !sessionState.userScores[newName]) {
        sessionState.userScores[newName] = { totalScore: 0, todayScore: 0, todayDate: todayStr(), subjectScores: {}, weeklyScores: {} };
        sessionState.currentProfile = newName;
        localStorage.setItem('userScores', JSON.stringify(sessionState.userScores));
        localStorage.setItem('currentProfile', newName);
        loadProfiles();
        $('#newProfileName').value = '';
        updateScoreDisplay();
      }
    }
    
    function switchProfile() {
      sessionState.currentProfile = $('#profileSelect').value;
      localStorage.setItem('currentProfile', sessionState.currentProfile);
      updateProfileImage();
      updateScoreDisplay();
      checkTodayScore();
    }
    
    function checkTodayScore() {
      const profile = sessionState.userScores[sessionState.currentProfile];
      if (profile && profile.todayDate !== todayStr()) {
        profile.todayScore = 0;
        profile.todayCount = 0;
        profile.todayDate = todayStr();
        saveScores();
      }
    }
    
    function updateProfileImage() {
      const profile = sessionState.userScores[sessionState.currentProfile];
      const placeholder = $('#profileImagePlaceholder');
      const img = $('#profileImage');
      if (profile && profile.image) {
        img.src = profile.image;
        img.classList.remove('hidden');
        placeholder.classList.add('hidden');
      } else {
        img.classList.add('hidden');
        placeholder.classList.remove('hidden');
      }
    }

    // ---------- Game Logic ----------
    function startSession() {
      if (sessionState.isSessionActive) return;
      sessionState.isSessionActive = true;
      
      sessionState.currentSubject = $('#subject').value;
      sessionState.currentLevel = $('#level').value;
      sessionState.totalQuestions = parseInt($('#sessionSize').value);
      sessionState.currentQuestionIndex = 0;
      sessionState.correctAnswers = 0;
      
      updateGameUI(true);
      
      sessionState.questions = generateQuestions(sessionState.currentSubject, sessionState.currentLevel, sessionState.totalQuestions);
      
      showQuestion();
    }
    
    function generateQuestions(subject, level, count) {
      if (!DATA[subject] || !DATA[subject][level]) {
        return [];
      }
      
      let allQuestions = DATA[subject][level].questions;
      let generated = [];
      while(generated.length < count && allQuestions.length > 0) {
        generated.push(allQuestions.shift());
      }
      return generated;
    }

    function showQuestion() {
      const q = sessionState.questions[sessionState.currentQuestionIndex];
      if (!q) {
        endSession();
        return;
      }
      
      const questionEl = $('#question');
      const optionsEl = $('#options');
      const textAnswerWrap = $('#textAnswerWrap');
      const feedbackEl = $('#feedback');
      
      questionEl.innerHTML = q.q;
      feedbackEl.textContent = '';
      
      // Resetta stato UI
      $('#nextQuestionBtn').classList.add('hidden');
      $('#drawingToggleBtn').disabled = false;
      
      // Gestione tipo di domanda
      optionsEl.innerHTML = '';
      textAnswerWrap.classList.add('hidden');
      if (q.options) {
        optionsEl.classList.remove('hidden');
        shuffle(q.options).forEach(opt => {
          const btn = document.createElement('button');
          btn.textContent = opt;
          btn.className = 'option rounded-xl font-semibold text-lg hover:bg-slate-200';
          btn.addEventListener('click', () => checkAnswer(opt, q.a));
          optionsEl.appendChild(btn);
        });
      } else {
        optionsEl.classList.add('hidden');
        textAnswerWrap.classList.remove('hidden');
        const textInput = $('#textAnswer');
        textInput.value = '';
        textInput.disabled = false;
        $('#submitTextBtn').disabled = false;
        textInput.focus();
        textInput.onkeypress = (e) => {
          if (e.key === 'Enter') {
            checkAnswer(textInput.value, q.a);
          }
        };
        $('#submitTextBtn').onclick = () => checkAnswer(textInput.value, q.a);
      }
      
      updateProgressBar();
    }
    
    function checkAnswer(userAnswer, correctAnswer) {
      userAnswer = String(userAnswer).trim().toLowerCase().replace(/\s/g, '');
      correctAnswer = String(correctAnswer).trim().toLowerCase().replace(/\s/g, '');
      
      const isCorrect = userAnswer === correctAnswer;
      const feedbackEl = $('#feedback');
      
      // Disabilita i controlli di risposta
      $$('.option').forEach(btn => btn.disabled = true);
      $('#textAnswer').disabled = true;
      $('#submitTextBtn').disabled = true;
      $('#drawingToggleBtn').disabled = true;

      if (isCorrect) {
        feedbackEl.textContent = "ü•≥ Esatto! Risposta corretta!";
        feedbackEl.className = "text-center font-bold text-lg mt-4 text-green-600";
        sessionState.correctAnswers++;
        updateScore(1);
        const correctBtn = $$('.option').find(btn => btn.textContent.toLowerCase().replace(/\s/g, '') === correctAnswer);
        if (correctBtn) correctBtn.classList.add('correct');
      } else {
        feedbackEl.textContent = `‚ùå Sbagliato. La risposta giusta era: "${correctAnswer}"`;
        feedbackEl.className = "text-center font-bold text-lg mt-4 text-red-600";
        updateScore(0);
        const wrongBtn = $$('.option').find(btn => btn.textContent.toLowerCase().replace(/\s/g, '') === userAnswer);
        if (wrongBtn) wrongBtn.classList.add('wrong');
        const correctBtn = $$('.option').find(btn => btn.textContent.toLowerCase().replace(/\s/g, '') === correctAnswer);
        if (correctBtn) correctBtn.classList.add('correct');
      }
      
      $('#nextQuestionBtn').classList.remove('hidden');
      if (sessionState.currentQuestionIndex >= sessionState.totalQuestions - 1) {
        $('#nextQuestionBtn').textContent = 'üè† Termina Sessione';
      }
    }
    
    function nextQuestion() {
      sessionState.currentQuestionIndex++;
      if (sessionState.currentQuestionIndex < sessionState.totalQuestions) {
        showQuestion();
      } else {
        endSession();
      }
    }
    
    function endSession() {
      sessionState.isSessionActive = false;
      updateGameUI(false);
      
      const finalScore = sessionState.correctAnswers;
      const totalQuestions = sessionState.totalQuestions;
      const scorePercentage = (finalScore / totalQuestions) * 100;
      
      const feedbackEl = $('#feedback');
      feedbackEl.textContent = `Partita conclusa! Hai risposto correttamente a ${finalScore} domande su ${totalQuestions} (${scorePercentage.toFixed(0)}%).`;
      feedbackEl.className = "text-center font-bold text-xl mt-4 text-sky-600";
      
      updateScoreDisplay();
      
      // Resetta i bottoni
      $('#nextQuestionBtn').classList.add('hidden');
      $('#drawingToggleBtn').disabled = true;
      toggleDrawingBox();
    }
    
    function updateGameUI(isActive) {
      $('#startBtn').classList.toggle('hidden', isActive);
      $('#stopSessionBtn').classList.toggle('hidden', !isActive);
      $('#subject').disabled = isActive;
      $('#level').disabled = isActive;
      $('#sessionSize').disabled = isActive;
      $$('.mathop').forEach(el => el.disabled = isActive);
      $('#nextQuestionBtn').textContent = '‚è≠Ô∏è Prossima Domanda';
      $('#question').textContent = isActive ? 'Caricamento...' : 'Premi "Inizia a Gioca!" per iniziare.';
      $('#options').innerHTML = '';
      $('#feedback').textContent = '';
    }

    // ---------- Score & Progress Management ----------
    function updateScore(points) {
      const profile = sessionState.userScores[sessionState.currentProfile];
      if (profile) {
        profile.totalScore += points;
        profile.todayScore += points;
        
        if (!profile.subjectScores[sessionState.currentSubject]) {
          profile.subjectScores[sessionState.currentSubject] = { correct: 0, total: 0 };
        }
        profile.subjectScores[sessionState.currentSubject].correct += points;
        profile.subjectScores[sessionState.currentSubject].total++;
        
        saveScores();
      }
      updateScoreDisplay();
    }
    
    function saveScores() {
      localStorage.setItem('userScores', JSON.stringify(sessionState.userScores));
    }

    function updateScoreDisplay() {
      const profile = sessionState.userScores[sessionState.currentProfile];
      if (!profile) return;

      const subjectScore = profile.subjectScores[sessionState.currentSubject];
      $('#subjectScore').textContent = subjectScore ? `${subjectScore.correct}/${subjectScore.total}` : "0/0";
      
      $('#todayCount').textContent = profile.todayCount || '0';
      $('#todayScore').textContent = profile.todayScore || '0';
      
      updateTotalScoresBySubject();
    }
    
    function updateTotalScoresBySubject() {
      const container = $('#totalScoresBySubject');
      container.innerHTML = '';
      const profile = sessionState.userScores[sessionState.currentProfile];
      if (!profile) return;
      
      for (const subject in profile.subjectScores) {
        const score = profile.subjectScores[subject];
        const div = document.createElement('div');
        div.className = "bg-white rounded-2xl p-4 shadow-inner text-center";
        div.innerHTML = `<span class="text-base">${subject}</span><br><b class="text-xl font-bold text-blue-500">${score.correct}/${score.total}</b>`;
        container.appendChild(div);
      }
    }

    function updateProgressBar() {
      const progress = (sessionState.currentQuestionIndex / sessionState.totalQuestions) * 100;
      $('#progressBar').style.width = `${progress}%`;
    }

    function showProgressDialog() {
      const profile = sessionState.userScores[sessionState.currentProfile];
      if (!profile) return;

      const dialog = $('#progressDialog');
      const summary = $('#progressSummary');
      const progressDate = $('#progressDate');
      
      progressDate.textContent = formatDateIt(todayStr());
      
      let html = `<p class="mb-4">Ciao ${sessionState.currentProfile}! Ecco i tuoi progressi:</p>`;
      
      html += `<div class="bg-blue-50 p-4 rounded-xl mb-4">
        <h4 class="text-xl font-bold text-blue-800">Riassunto di oggi</h4>
        <p>Domande giocate oggi: <strong>${profile.todayCount || 0}</strong></p>
        <p>Punti totali oggi: <strong>${profile.todayScore || 0}</strong></p>
      </div>`;
      
      html += `<div class="bg-green-50 p-4 rounded-xl">
        <h4 class="text-xl font-bold text-green-800">Statistiche per materia</h4>
        <ul>`;
      for (const subject in profile.subjectScores) {
        const score = profile.subjectScores[subject];
        html += `<li><strong>${subject}:</strong> Risposte corrette ${score.correct} su ${score.total}</li>`;
      }
      html += `</ul></div>`;
      
      summary.innerHTML = html;
      dialog.showModal();
    }

    // ---------- Event Listeners ----------
    document.addEventListener('DOMContentLoaded', () => {
      initProfiles();
      initDrawingSystem();
      
      $('#startBtn').addEventListener('click', startSession);
      $('#stopSessionBtn').addEventListener('click', endSession);
      $('#nextQuestionBtn').addEventListener('click', nextQuestion);
      
      $('#profileSelect').addEventListener('change', switchProfile);
      $('#addProfileBtn').addEventListener('click', addProfile);
      
      $('#subject').addEventListener('change', (e) => {
        sessionState.currentSubject = e.target.value;
        $('#mathOpsWrap').classList.toggle('hidden', sessionState.currentSubject !== 'Matematica');
        updateScoreDisplay();
      });
      $('#level').addEventListener('change', (e) => {
        sessionState.currentLevel = e.target.value;
        updateScoreDisplay();
      });
      
      $('#progressBtn').addEventListener('click', showProgressDialog);
      
      $('#profileImagePlaceholder').addEventListener('click', () => {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        input.onchange = (e) => {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = (event) => {
              const profile = sessionState.userScores[sessionState.currentProfile];
              if (profile) {
                profile.image = event.target.result;
                saveScores();
                updateProfileImage();
              }
            };
            reader.readAsDataURL(file);
          }
        };
        input.click();
      });
      
      $('#zoomInBtn').addEventListener('click', () => {
        const currentZoom = parseFloat(document.body.style.transform.replace('scale(', '').replace(')', '')) || 1;
        document.body.style.transform = `scale(${currentZoom + 0.1})`;
        $('#zoomDisplay').textContent = `${Math.round((currentZoom + 0.1) * 100)}%`;
      });

      $('#zoomOutBtn').addEventListener('click', () => {
        const currentZoom = parseFloat(document.body.style.transform.replace('scale(', '').replace(')', '')) || 1;
        document.body.style.transform = `scale(${Math.max(0.5, currentZoom - 0.1)})`;
        $('#zoomDisplay').textContent = `${Math.round(Math.max(0.5, currentZoom - 0.1) * 100)}%`;
      });
    });
  })();
  </script>
</body>
</html>
