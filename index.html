<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Impara & Gioca!</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Fredoka', sans-serif;
            background: linear-gradient(to bottom right, #f0f9ff, #e0f2fe);
            transition: transform 0.3s ease-in-out;
            transform-origin: top center;
        }
        .bg-card { background: linear-gradient(180deg, #dbeafe, #eff6ff); }
        .shadow-card { box-shadow: 0 15px 30px rgba(0,0,0,0.1); }
        .tag { background: #ffffff; border: 1px solid #dbeafe; color: #0c4a6e; }
        button {
            font-weight: 700;
            transition: transform 0.2s, box-shadow 0.2s, opacity 0.2s;
        }
        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        button:active:not(:disabled) { transform: translateY(0); box-shadow: none; }
        button:disabled, select:disabled, input:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .option {
            font-size: 1.25rem; padding: 1rem; border: 3px solid #cbd5e1;
            background: #f1f5f9; transition: border-color 0.2s, background-color 0.2s;
        }
        .option.correct { border-color: #22c55e; background: #dcfce7; }
        .option.wrong { border-color: #ef4444; background: #fee2e2; }
        .progress-bar { transition: width 0.3s ease-in-out; }
        dialog {
            padding: 0; border: none; border-radius: 1.5rem;
            max-width: 800px; width: 90%;
        }
        dialog::backdrop { background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(5px); }
    </style>
</head>
<body class="text-slate-800">

    <!-- Header -->
    <header class="p-6 bg-sky-300 text-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto flex flex-col sm:flex-row gap-4 items-center justify-between">
            <div class="flex items-center gap-4">
                <div class="text-4xl">üöÄ</div>
                <h1 class="text-3xl font-bold">Impara & Gioca!</h1>
                <div class="flex items-center gap-2 bg-sky-400 p-1 rounded-full ml-4">
                    <button id="zoomOutBtn" class="text-2xl font-bold w-8 h-8 rounded-full bg-white text-sky-500 hover:bg-sky-100">-</button>
                    <span id="zoomDisplay" class="text-lg font-semibold w-16 text-center" title="Livello di zoom">100%</span>
                    <button id="zoomInBtn" class="text-2xl font-bold w-8 h-8 rounded-full bg-white text-sky-500 hover:bg-sky-100">+</button>
                </div>
            </div>
            <div class="flex flex-wrap items-center gap-4">
                <label class="tag flex items-center gap-2 p-2 rounded-full text-lg">
                    <span class="text-xl">üë§</span> Io sono:
                    <select id="profileSelect" class="bg-transparent border-none text-lg font-semibold cursor-pointer outline-none"></select>
                </label>
                <input id="newProfileName" type="text" placeholder="Nome nuovo amico" class="p-2 rounded-full text-slate-800 text-lg placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                <button id="addProfileBtn" class="bg-blue-500 text-white rounded-full px-6 py-2">Aggiungi un amico!</button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto p-4 md:p-8">
        <div class="bg-card shadow-card rounded-3xl p-6">
            <!-- Game Options -->
            <div class="flex flex-col md:flex-row gap-4 mb-6">
                <div class="flex flex-wrap items-center gap-4">
                    <span class="tag flex items-center gap-2 p-2 rounded-full text-lg">
                        <span class="text-xl">üìò</span> Materia:
                        <select id="subject" class="bg-transparent border-none text-lg font-semibold cursor-pointer outline-none">
                            <option>Matematica</option> <option>Inglese</option> <option>Italiano</option> <option>Geografia</option> <option>Scienze</option> <option>Musica</option>
                        </select>
                    </span>
                    <span class="tag flex items-center gap-2 p-2 rounded-full text-lg">
                        <span class="text-xl">üéØ</span> Livello:
                        <select id="level" class="bg-transparent border-none text-lg font-semibold cursor-pointer outline-none">
                            <option value="easy">Facile ‚≠ê</option> <option value="medium">Medio ‚≠ê‚≠ê</option> <option value="hard">Difficile ‚≠ê‚≠ê‚≠ê</option>
                        </select>
                    </span>
                    <span id="mathOpsWrap" class="tag flex items-center gap-2 p-2 rounded-full text-lg hidden">
                        <span class="text-xl">‚ûó</span> Operazioni:
                        <label class="flex items-center gap-1 text-base"><input type="checkbox" class="mathop" value="add" checked> +</label>
                        <label class="flex items-center gap-1 text-base"><input type="checkbox" class="mathop" value="sub" checked> ‚àí</label>
                        <label class="flex items-center gap-1 text-base"><input type="checkbox" class="mathop" value="mul" checked> √ó</label>
                        <label class="flex items-center gap-1 text-base"><input type="checkbox" class="mathop" value="div" checked> √∑</label>
                    </span>
                </div>
                <div class="flex flex-wrap items-center gap-4 mt-4 md:mt-0 md:ml-auto">
                    <span class="tag flex items-center gap-2 p-2 rounded-full text-lg">
                        <span class="text-xl">üì¶</span> Domande:
                        <select id="sessionSize" class="bg-transparent border-none text-lg font-semibold cursor-pointer outline-none">
                            <option>5</option><option selected>10</option><option>15</option><option>20</option><option>30</option><option>40</option><option>50</option>
                        </select>
                    </span>
                    <button id="startBtn" class="bg-green-500 text-white rounded-full px-8 py-3 text-xl">Inizia a Giocare! üöÄ</button>
                </div>
            </div>

            <!-- Progress Bar -->
            <div class="h-4 bg-sky-200 rounded-full overflow-hidden my-6">
                <div id="progressBar" class="h-full bg-green-400 progress-bar rounded-full"></div>
            </div>

            <!-- Question & Help -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white shadow-md rounded-2xl p-6">
                    <h3 class="text-2xl font-bold mb-4">üß© Domanda</h3>
                    <div id="question" class="min-h-[150px] flex items-center justify-center p-4 border-4 border-dashed border-blue-200 rounded-xl text-2xl text-center">Premi ‚ÄúInizia a Gioca!‚Äù per iniziare.</div>
                    <div class="options grid gap-4 mt-6" id="options"></div>
                    <div class="text-center font-semibold text-lg mt-4" id="feedback"></div>
                </div>
                <div class="bg-white shadow-md rounded-2xl p-6">
                    <h3 class="text-2xl font-bold mb-4">üí° Aiuto & Suggerimenti</h3>
                    <div id="helpBox" class="min-h-[150px] flex items-center justify-center p-4 border-4 border-dashed border-blue-200 rounded-xl text-xl text-center">Inizia una partita per ricevere aiuto!</div>
                    <div class="flex flex-wrap gap-3 mt-6 justify-center">
                        <button id="hintBtn" class="bg-yellow-400 text-slate-800 rounded-full px-6 py-2 text-lg">üí° Aiuto</button>
                        <button id="explainBtn" class="bg-orange-400 text-slate-800 rounded-full px-6 py-2 text-lg">üìñ Spiegazione</button>
                        <button id="flashBtn" class="bg-purple-400 text-white rounded-full px-6 py-2 text-lg">üÉè Flashcard</button>
                    </div>
                </div>
            </div>

            <!-- Statistics -->
            <div class="mt-8">
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 text-center">
                    <div class="bg-white rounded-2xl p-5 shadow-inner">
                        <span class="text-lg">‚≠ê Punteggio materia (selezionata)</span><br>
                        <b id="subjectScore" class="text-3xl font-bold text-blue-500">0</b>
                    </div>
                    <div class="bg-white rounded-2xl p-5 shadow-inner">
                        <span class="text-lg">üóìÔ∏è Gioco di oggi</span><br>
                        <b id="todayCount" class="text-3xl font-bold text-purple-500">0</b>
                    </div>
                    <div class="bg-white rounded-2xl p-5 shadow-inner">
                        <span class="text-lg">üèÜ Punteggio totale oggi</span><br>
                        <b id="todayScore" class="text-3xl font-bold text-green-500">0</b>
                    </div>
                </div>
                <div class="mt-8">
                    <h3 class="text-2xl font-bold mb-4 text-center text-slate-700">Punteggi Totali per Materia</h3>
                    <div id="totalScoresBySubject" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 text-center"></div>
                </div>
            </div>

            <div class="flex justify-center mt-8">
                <button id="progressBtn" class="bg-sky-400 text-white rounded-full px-8 py-3 text-lg">Mostra i miei progressi üìà</button>
            </div>
        </div>
    </main>

    <!-- Progress Dialog -->
    <dialog id="progressDialog">
        <div class="bg-sky-100 p-8 rounded-3xl shadow-xl border-4 border-blue-200">
            <h3 class="text-3xl font-bold text-center mb-6">üìà I Tuoi Progressi</h3>
            <div id="progressSummary" class="text-lg"></div>
            <div class="text-center mt-6">
                <button class="bg-red-400 text-white rounded-full px-8 py-3 text-lg" onclick="this.closest('dialog').close()">Chiudi ‚ùå</button>
            </div>
        </div>
    </dialog>

    <script>
    (function(){
        // ---------- Utilities ----------
        const $ = sel => document.querySelector(sel);
        const $$ = sel => Array.from(document.querySelectorAll(sel));
        const todayStr = () => new Date().toISOString().slice(0, 10);
        const rand = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
        const shuffle = arr => arr.map(v => [Math.random(), v]).sort((a, b) => a[0] - b[0]).map(x => x[1]);
        const pick = arr => arr[rand(0, arr.length - 1)];
        const simpleRandomId = () => `id-${Date.now().toString(36)}-${Math.random().toString(36).substring(2)}`;

        // ---------- Storage (Resilient Loading) ----------
        const STORAGE_KEY = 'kids_learner_v2';
        const defaultSubjects = ['Matematica', 'Inglese', 'Italiano', 'Geografia', 'Scienze', 'Musica'];
        const baseStats = () => ({ subjectScore: { easy: 0, medium: 0, hard: 0 }, today: {}, unique: new Set(), uniqueArr: [] });

        function load() {
            let data;
            try {
                const storedData = localStorage.getItem(STORAGE_KEY);
                if (storedData) {
                    data = JSON.parse(storedData);
                    if (data.version !== 2) throw new Error("Invalid data version");
                } else {
                    throw new Error("No data found");
                }
            } catch (e) {
                console.warn("Could not load data, starting fresh.", e.message);
                const id = simpleRandomId();
                data = {
                    version: 2,
                    currentProfileId: id,
                    profiles: [{ id, name: 'Bimbo', created: new Date().toISOString(), subjects: objFromArray(defaultSubjects, baseStats) }]
                };
                save(data);
            }
            // Data migration and validation
            data.profiles.forEach(p => {
                defaultSubjects.forEach(s => {
                    p.subjects[s] = p.subjects[s] || baseStats();
                    if (typeof p.subjects[s].subjectScore !== 'object' || p.subjects[s].subjectScore === null) {
                        p.subjects[s].subjectScore = { easy: 0, medium: 0, hard: 0 };
                    }
                    p.subjects[s].unique = new Set(p.subjects[s].uniqueArr || []);
                });
            });
            return data;
        }

        function save(data) {
            try {
                const clone = JSON.parse(JSON.stringify(data));
                clone.profiles.forEach(p => {
                    defaultSubjects.forEach(s => {
                        if (p.subjects[s] && p.subjects[s].unique) {
                            p.subjects[s].uniqueArr = Array.from(p.subjects[s].unique);
                            delete p.subjects[s].unique;
                        }
                    });
                });
                localStorage.setItem(STORAGE_KEY, JSON.stringify(clone));
            } catch (e) { console.error("Failed to save data:", e); }
        }

        function objFromArray(arr, fn) { const o = {}; arr.forEach(k => o[k] = fn()); return o; }

        // ---------- State ----------
        let app = load();
        let session = { running: false, size: 10, index: 0, current: null };

        // ---------- UI Management ----------
        function initProfiles() {
            const sel = $('#profileSelect');
            sel.innerHTML = '';
            app.profiles.forEach(p => { const opt = document.createElement('option'); opt.value = p.id; opt.textContent = p.name; sel.appendChild(opt); });
            sel.value = app.currentProfileId;
            updateAllUI();
        }

        function updateAllUI() {
            updateHeaderStats();
            updateTotalScoresDisplay();
            updateButtonStates();
        }

        function updateHeaderStats() {
            const p = getCurrentProfile();
            const subjData = p.subjects[$('#subject').value] || baseStats();
            const scores = subjData.subjectScore;
            const totalScore = (scores.easy || 0) + (scores.medium || 0) + (scores.hard || 0);
            $('#subjectScore').textContent = totalScore;
            updateTodayKpis();
        }

        function getCurrentProfile() {
            return app.profiles.find(p => p.id === app.currentProfileId) || app.profiles[0];
        }

        function updateTotalScoresDisplay() {
            const container = $('#totalScoresBySubject');
            const profile = getCurrentProfile();
            container.innerHTML = '';
            defaultSubjects.forEach(subject => {
                const subjScores = (profile.subjects[subject] || baseStats()).subjectScore;
                const total = (subjScores.easy || 0) + (subjScores.medium || 0) + (subjScores.hard || 0);
                container.innerHTML += `
                    <div class="bg-white rounded-2xl p-3 shadow-inner">
                        <span class="text-base font-semibold text-sky-800">${subject}</span><br>
                        <b class="text-2xl font-bold text-blue-600">${total}</b>
                        <div class="text-xs text-slate-500 mt-1 grid grid-cols-3 gap-1">
                           <span>F: <b class="text-green-600">${subjScores.easy || 0}</b></span>
                           <span>M: <b class="text-orange-500">${subjScores.medium || 0}</b></span>
                           <span>D: <b class="text-red-600">${subjScores.hard || 0}</b></span>
                        </div>
                    </div>`;
            });
        }

        function updateButtonStates() {
            const isRunning = session.running;
            ['#subject', '#level', '#sessionSize', '#profileSelect', '#addProfileBtn', '#newProfileName', '#startBtn'].forEach(sel => $(sel).disabled = isRunning);
            ['#hintBtn', '#explainBtn', '#flashBtn'].forEach(sel => $(sel).disabled = !isRunning);
        }
        
        // ---------- Question Generators (omitted for brevity) ----------
        function uniqueKeyGuard(profile, subject, key){ const s = profile.subjects[subject]; if(s.unique.has(key)) return false; s.unique.add(key); if(s.unique.size > 200) s.unique = new Set(Array.from(s.unique).slice(-200)); return true; }
        const Generators = {
            Matematica(level){
                const enabled = $$('.mathop:checked').map(i=>i.value);
                const op = pick(enabled.length?enabled:['add','sub','mul','div']);
                const ranges = {easy:[1,10], medium:[5,20], hard:[10,50]};
                const [a,b] = (()=>{
                    const [min,max]=ranges[level];
                    if(op==='div'){ const divisor = rand(min, Math.max(min,Math.floor(max/2))); const quotient = rand(min, max>=30?10:max); return [divisor*quotient, divisor]; }
                    return [rand(min,max), rand(min,max)];
                })();
                const text = {add:`${a} + ${b} = ?`, sub:`${a} ‚àí ${b} = ?`, mul:`${a} √ó ${b} = ?`, div:`${a} √∑ ${b} = ?`}[op];
                const answer = {add:a+b, sub:a-b, mul:a*b, div:Math.floor(a/b)}[op];
                const key = `M:${level}:${op}:${a}:${b}`;
                return { ok: (p)=>uniqueKeyGuard(p,'Matematica',key), q:text, options: makeNumberOptions(answer, level), correct: String(answer), hint: `Pensa ad aggiungere üëÜ o togliere üëá i numeri.`, explain: `Ricorda le regole di ${op}: la ${op==='add'?'somma':op==='sub'?'sottrazione':op==='mul'?'moltiplicazione':'divisione'} tra due numeri.`, flashcard: `1Ô∏è‚É£ Scrivi il primo numero.<br>2Ô∏è‚É£ Esegui l'operazione.<br>3Ô∏è‚É£ Scrivi il risultato.` };
            },
            Inglese(level){
                const wordsEasy = [['cat','gatto'],['dog','cane'],['house','casa'],['sun','sole'],['book','libro'],['car','auto'],['apple','mela'],['ball','palla'],['tree','albero'],['bird','uccello']];
                const wordsMed = [['family','famiglia'],['friend','amico'],['beautiful','bello'],['together','insieme'],['happy','felice'],['water','acqua'],['food','cibo'],['school','scuola'],['teacher','insegnante'],['student','studente']];
                const wordsHard = [['thought','pensiero'],['tomorrow','domani'],['usually','di solito'],['question','domanda'],['answer','risposta'],['develop','sviluppare'],['community','comunit√†'],['knowledge','conoscenza'],['important','importante'],['different','diverso']];
                const bank = level==='easy'?wordsEasy:level==='medium'?wordsMed:wordsHard;
                const [en,it] = pick(bank);
                const mode = pick(['it->en','en->it']);
                let q,correct,opts,hint,explain,flashcard;
                if(mode==='it->en'){ q = `Traduci in inglese: ‚Äú${it}‚Äù`; correct = en; opts = makeTextOptions(correct, bank.map(x=>x[0])); hint = `Pensa alla parola inglese che hai imparato per ‚Äú${it}‚Äù`; explain = `Ricorda i suoni e le lettere delle parole inglesi.`; flashcard = `üáÆüáπ ‚Üí üá¨üáß\nGuarda la parola in italiano e prova a ricordare la sua traduzione.`; } else { q = `Cosa vuol dire in italiano: ‚Äú${en}‚Äù`; correct = it; opts = makeTextOptions(correct, bank.map(x=>x[1])); hint = `Prova a ricordare il significato in italiano di "${en}".`; explain = `Ricorda le parole italiane che corrispondono alle parole inglesi.`; flashcard = `üá¨üáß ‚Üí üáÆüáπ\nGuarda la parola in inglese e prova a ricordare la sua traduzione.`; }
                const key = `E:${level}:${en}:${mode}`; return { ok:(p)=>uniqueKeyGuard(p,'Inglese',key), q, options:opts, correct, hint, explain, flashcard };
            },
            Italiano(level){
                const modes = ['articolo','vocale','plurale','aggettivo']; const mode = pick(modes);
                if(mode==='articolo'){ const nouns=[['___ albero','l\''],['___ zaino','lo '],['___ scuola','la '],['___ ombrello','l\''],['___ gatto','il '],['___ tigre','la ']]; const [phrase, art] = pick(nouns); const opts = makeTextOptions(art.trim(), ['il','lo','la','l\'']); return pack('Completa con la parolina giusta: '+phrase, art.trim(), opts, 'Guarda la prima lettera della parola dopo.','Ricorda le regole per usare gli articoli determinativi.','L\'articolo determinativo accompagna il nome.'); }
                if(mode==='vocale'){ const letter = pick('aeiou'.split('')); const opts = makeTextOptions('vocale',['vocale','consonante']); return pack(`La letterina "${letter}" √® una‚Ä¶`, 'vocale', opts, 'Quando pronunci il suono, l\'aria esce libera dalla bocca.', 'Le vocali sono A, E, I, O, U.'); }
                if(mode==='plurale'){ const words=[['libro','libri'],['mela','mele'],['amico','amici'],['palla','palle'],['fiore','fiori']]; const [sing,plu]=pick(words); const q=`Qual √® il plurale di "${sing}"?`; const opts = makeTextOptions(plu, words.map(x=>x[1])); return pack(q,plu,opts,'Cambia l\'ultima letterina della parola.','Ricorda come si forma il plurale dei nomi.','Se il nome finisce con -o, il plurale √® -i. Se finisce con -a, √® -e.'); }
                if(mode==='aggettivo'){ const adjectives=[['alto','alta','alti','alte'],['bello','bella','belli','belle']]; const [m_s, f_s, m_p, f_p] = pick(adjectives); const choice = pick(['m_s','f_s','m_p','f_p']); let q, correct; if(choice === 'm_s'){q=`Qual √® il femminile di "${m_s}"?`; correct=f_s;} if(choice === 'f_s'){q=`Qual √® il plurale maschile di "${f_s}"?`; correct=m_p;} if(choice === 'm_p'){q=`Qual √® il singolare di "${m_p}"?`; correct=m_s;} if(choice === 'f_p'){q=`Qual √® il singolare femminile di "${f_p}"?`; correct=f_s;} const opts = makeTextOptions(correct, [m_s, f_s, m_p, f_p]); return pack(q,correct,opts,'Pensa a come l\'aggettivo cambia.','Gli aggettivi concordano in genere e numero con il nome.','Ricorda le desinenze: -o/-a e -i/-e.'); }
                function pack(q,c,o,h,e,f){const k=`I:${level}:${q}`;return{ok:(p)=>uniqueKeyGuard(p,'Italiano',k),q,correct:c,options:o,hint:h,explain:e,flashcard:f};}
            },
            Geografia(level){ const capitals = {Europa:[['Italia','Roma'],['Francia','Parigi'],['Spagna','Madrid'],['Germania','Berlino']], Mondo:[['Giappone','Tokyo'],['USA','Washington'],['Brasile','Brasilia'],['Cina','Pechino']]}; const pool = level==='easy'?capitals.Europa:capitals.Mondo; const [country,cap] = pick(pool); const q=`Qual √® la capitale di ${country}?`; const opts = makeTextOptions(cap, pool.map(x=>x[1])); const key=`G:${level}:${country}`; return {ok:(p)=>uniqueKeyGuard(p,'Geografia',key), q, correct:cap, options:opts, hint:'√à la citt√† pi√π importante.', explain:`La capitale di ${country} √® ${cap}.`, flashcard:`Paese ‚Üí Capitale`}; },
            Scienze(level){ const modes = ['stato','animali','corpo','piante']; const mode = pick(modes); if(mode==='stato'){ const items=[['ghiaccio','solido'],['acqua','liquido'],['vapore','gassoso']]; const [mat,st]=pick(items); const q=`Lo stato del "${mat}" √®‚Ä¶`; const opts=makeTextOptions(st,['solido','liquido','gassoso']); return pack(q,st,opts,'Pensa a com\'√® fatto.', 'Ricorda i tre stati della materia.', 'Solido (forma fissa), liquido (scorre), gassoso (si espande).'); } if(mode==='animali'){ const items=[['delfino','mammifero'],['aquila','uccello'],['trota','pesce']]; const [ani,cl]=pick(items); const opts=makeTextOptions(cl,['mammifero','uccello','pesce','anfibio']); return pack(`Il ${ani} √® un‚Ä¶`,cl,opts,'Pensa a come nasce e come respira.', 'Ricorda le classi degli animali.', ' mammifero, uccello, pesce, ecc.'); } if(mode==='corpo'){ const items=[['cuore','pompa il sangue'],['polmoni','respirare'],['stomaco','digerire il cibo']]; const [org,fun]=pick(items); const q=`Il ${org} serve per‚Ä¶`; const opts=makeTextOptions(fun, items.map(x=>x[1])); return pack(q,fun,opts,'√à un organo, che funzione ha?', 'Ogni organo del corpo ha una funzione.', 'Il corpo ha tante parti che lavorano insieme.'); } if(mode==='piante'){ const items=[['radici','assorbire acqua'],['foglie','fare la fotosintesi'],['fiore','fare i semi']]; const [parte,fun]=pick(items); const q=`Le ${parte} servono per‚Ä¶`; const opts=makeTextOptions(fun, items.map(x=>x[1])); return pack(q,fun,opts,'Pensa a cosa fa quella parte.', 'Ricorda le funzioni delle parti di una pianta.', 'Radici, fusto, foglie, fiore.'); } function pack(q,c,o,h,e,f){const k=`S:${level}:${q}`;return{ok:(p)=>uniqueKeyGuard(p,'Scienze',k),q,correct:c,options:o,hint:h,explain:e,flashcard:f};} },
            Musica(level){ const modes = ['famiglia','ritmo','note']; const mode = pick(modes); if(mode==='famiglia'){ const items=[['violino','archi'],['flauto','fiati'],['tromba','ottoni']]; const [inst,fam]=pick(items); const q=`A quale famiglia appartiene il ${inst}?`; const opts=makeTextOptions(fam,['archi','fiati','ottoni','percussioni']); return pack(q,fam,opts,'Pensa a come si suona.', 'Gli strumenti si raggruppano in famiglie.', 'Archi, fiati, ottoni, percussioni.'); } if(mode==='ritmo'){ const items=[['semibreve','4 battiti'],['minima','2 battiti'],['semiminima','1 battito']]; const [note,val]=pick(items); const q=`Una ${note} vale‚Ä¶`; const opts=makeTextOptions(val,['4 battiti','2 battiti','1 battito']); return pack(q,val,opts,'Pensa a quanto dura il suono.', 'Ripassa la durata delle note.', 'Semibreve (4), Minima (2), Semiminima (1).'); } if(mode==='note'){ const noteSeq=['do','re','mi','fa','sol','la','si']; const idx=rand(0,noteSeq.length-2); const q=`Quale nota viene dopo "${noteSeq[idx]}"?`; const correct=noteSeq[idx+1]; const opts=makeTextOptions(correct, noteSeq); return pack(q,correct,opts,'Pensa alla scala musicale.', 'Ricorda la sequenza delle note.', 'Do, Re, Mi, Fa, Sol, La, Si.'); } function pack(q,c,o,h,e,f){const k=`Mu:${level}:${q}`;return{ok:(p)=>uniqueKeyGuard(p,'Musica',k),q,correct:c,options:o,hint:h,explain:e,flashcard:f};} }
        };
        function makeNumberOptions(answer, level) { const spread = level === 'easy' ? 3 : level === 'medium' ? 7 : 12; const set = new Set([String(answer)]); while (set.size < 4) { set.add(String(answer + rand(-spread, spread))); } return shuffle(Array.from(set)); }
        function makeTextOptions(correct, pool) { const set = new Set([correct]); const shuffled = shuffle(pool); for (const x of shuffled) { if (set.size >= 4) break; if (x !== correct) set.add(x); } return shuffle(Array.from(set)); }
        function pickGenerator() { const subj = $('#subject').value; const level = $('#level').value; return () => Generators[subj](level); }

        // ---------- Session & Scoring ----------
        const POINTS = { easy: 10, medium: 15, hard: 20 };

        function recordResult(correct) {
            const profile = getCurrentProfile();
            const subj = $('#subject').value;
            const level = $('#level').value;
            const pts = correct ? POINTS[level] : 0;
            const subjStats = profile.subjects[subj];
            
            if (typeof subjStats.subjectScore !== 'object' || subjStats.subjectScore === null) {
                subjStats.subjectScore = { easy: 0, medium: 0, hard: 0 };
            }
            subjStats.subjectScore[level] += pts;

            const today = subjStats.today[todayStr()] || (subjStats.today[todayStr()] = { score: 0, completed: 0 });
            today.score += pts; today.completed += 1;
            save(app);
            updateAllUI();
        }

        function updateTodayKpis() {
            const p = getCurrentProfile(); const date = todayStr();
            let totalScore = 0, totalCount = 0;
            defaultSubjects.forEach(s => { const d = p.subjects[s].today[date]; if (d) { totalScore += d.score; totalCount += d.completed; } });
            $('#todayScore').textContent = totalScore; $('#todayCount').textContent = totalCount;
        }

        function startSession() {
            session = { running: true, size: parseInt($('#sessionSize').value, 10), index: 0, current: null };
            $('#progressBar').style.width = '0%';
            updateButtonStates();
            nextQuestion();
        }

        function nextQuestion() {
            const gen = pickGenerator();
            const profile = getCurrentProfile();
            let attempt = 0, pak;
            
            while(attempt < 50) {
                pak = gen();
                if (pak && typeof pak.ok === 'function' && pak.ok(profile)) {
                    break; 
                }
                attempt++;
            }
            
            if (attempt >= 50) {
                session.running = false;
                $('#question').innerHTML = 'Congratulazioni! Non ci sono pi√π domande uniche per queste impostazioni!';
                $('#options').innerHTML = ''; $('#feedback').textContent = 'Prova un altro livello o materia.';
                updateButtonStates(); return;
            }

            session.current = pak;
            $('#question').innerHTML = pak.q;
            const ops = $('#options'); ops.innerHTML = '';
            pak.options.forEach(opt => {
                const b = document.createElement('div');
                b.className = 'option rounded-xl cursor-pointer hover:bg-sky-200';
                b.textContent = opt; b.tabIndex = 0;
                b.addEventListener('click', () => selectAnswer(b, opt));
                ops.appendChild(b);
            });
            $('#helpBox').innerHTML = 'Premi i bottoni per un aiuto!';
            $('#feedback').textContent = '';
        }

        function selectAnswer(el, value) {
            if (!session.running) return;
            session.running = false; // Previeni doppi click
            
            const correct = String(value).trim().toLowerCase() === String(session.current.correct).trim().toLowerCase();
            $$('#options .option').forEach(o => o.style.pointerEvents = 'none');
            el.classList.add(correct ? 'correct' : 'wrong');
            $('#feedback').innerHTML = correct ? `ü•≥ Bravissimo! +${POINTS[$('#level').value]} punti!` : `üò¢ Ops! La risposta era: <b>${session.current.correct}</b>.`;
            recordResult(correct);

            setTimeout(() => {
                session.index++;
                $('#progressBar').style.width = `${Math.min(100, (session.index / session.size) * 100)}%`;
                
                if (session.index >= session.size) {
                    $('#question').innerHTML = `üéâ Grandioso! Hai finito tutte le domande! üéâ`;
                    $('#options').innerHTML = ''; $('#feedback').textContent = '';
                    $('#helpBox').innerHTML = 'Hai completato la sessione! Gioca ancora!';
                    updateButtonStates();
                } else {
                    session.running = true; // Riabilita per la prossima domanda
                    nextQuestion();
                }
            }, 1500);
        }

        // ---------- Event Listeners Setup ----------
        function setupEventListeners() {
            $('#startBtn').addEventListener('click', startSession);
            $('#hintBtn').addEventListener('click', () => { if (session.current) $('#helpBox').innerHTML = 'üí° <b>Aiuto:</b> ' + session.current.hint; });
            $('#explainBtn').addEventListener('click', () => { if (session.current) $('#helpBox').innerHTML = 'üìñ <b>Spiegazione:</b> ' + session.current.explain; });
            $('#flashBtn').addEventListener('click', () => { if (session.current) $('#helpBox').innerHTML = 'üÉè <b>Flashcard:</b><br>' + session.current.flashcard; });

            $('#addProfileBtn').addEventListener('click', () => {
                const name = ($('#newProfileName').value || '').trim();
                if (!name) { alert('Per favore, scrivi il nome del nuovo amico!'); return; }
                const id = simpleRandomId();
                app.profiles.push({ id, name, created: new Date().toISOString(), subjects: objFromArray(defaultSubjects, baseStats) });
                app.currentProfileId = id;
                save(app); initProfiles();
                $('#newProfileName').value = '';
            });

            $('#profileSelect').addEventListener('change', (e) => { app.currentProfileId = e.target.value; save(app); updateAllUI(); });
            $('#subject').addEventListener('change', () => { $('#mathOpsWrap').classList.toggle('hidden', $('#subject').value !== 'Matematica'); updateHeaderStats(); });
            $('#level').addEventListener('change', updateHeaderStats);

            $('#progressBtn').addEventListener('click', () => {
                const p = getCurrentProfile(); const date = todayStr();
                let html = '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">'; let totalScoreToday = 0, totalCompletedToday = 0;
                defaultSubjects.forEach(s => {
                    const subjData = p.subjects[s] || baseStats();
                    const todayData = subjData.today[date];
                    const scoreToday = todayData ? todayData.score : 0; 
                    const completedToday = todayData ? todayData.completed : 0;
                    const totalScores = subjData.subjectScore;
                    const totalSubjectScore = (totalScores.easy || 0) + (totalScores.medium || 0) + (totalScores.hard || 0);
                    
                    totalScoreToday += scoreToday; 
                    totalCompletedToday += completedToday;

                    if (totalSubjectScore > 0 || completedToday > 0) {
                        html += `
                        <div class="bg-white rounded-xl p-4 shadow-inner text-base">
                            <div class="font-bold text-sky-700 text-xl mb-1">${s}</div>
                            <div>Oggi: <b class="text-purple-500">${completedToday}</b> attivit√† ‚Ä¢ <b class="text-green-500">${scoreToday}</b> punti</div>
                            <div class="mt-1">Punteggio Totale: <b class="text-blue-600 text-lg">${totalSubjectScore}</b> punti</div>
                            <div class="text-sm text-slate-600 mt-1">
                                (Facile: <b class="text-green-600">${totalScores.easy || 0}</b>, 
                                Medio: <b class="text-orange-600">${totalScores.medium || 0}</b>, 
                                Difficile: <b class="text-red-600">${totalScores.hard || 0}</b>)
                            </div>
                        </div>`;
                    }
                });
                html += '</div>';
                html += `<div class="bg-sky-200 rounded-xl p-4 mt-6 text-xl font-bold shadow-md text-center">Totale Oggi: <b>${totalCompletedToday}</b> attivit√† ‚Ä¢ <b>${totalScoreToday}</b> punti</div>`;
                $('#progressSummary').innerHTML = html; $('#progressDialog').showModal();
            });
            
            let currentScale = 1.0; const ZOOM_STEP = 0.15, MAX_ZOOM = 1.6, MIN_ZOOM = 0.85;
            const updateZoom = () => { currentScale = Math.round(currentScale * 100) / 100; document.body.style.transform = `scale(${currentScale})`; $('#zoomDisplay').textContent = `${Math.round(currentScale * 100)}%`; $('#zoomInBtn').disabled = currentScale >= MAX_ZOOM; $('#zoomOutBtn').disabled = currentScale <= MIN_ZOOM; };
            $('#zoomInBtn').addEventListener('click', () => { if (currentScale < MAX_ZOOM) { currentScale += ZOOM_STEP; updateZoom(); } });
            $('#zoomOutBtn').addEventListener('click', () => { if (currentScale > MIN_ZOOM) { currentScale -= ZOOM_STEP; updateZoom(); } });
            updateZoom();
        }
        
        // ---------- App Boot ----------
        initProfiles();
        $('#mathOpsWrap').classList.toggle('hidden', $('#subject').value !== 'Matematica');
        setupEventListeners();
    })();
    </script>
</body>
</html>
